<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HG AI Agents</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* --- [í…Œë§ˆ ì •ì˜: ëŒ€ë‚˜ë¬´ íŒë‹¤ ì»¨ì…‰] --- */
        :root {
            --bg-main: #e9f5ec;       
            --panel-bg: #ffffff;      
            --accent-dark: #2d5a27;   
            --accent-light: #81c784;  
            --text-primary: #1b3318;  
            --msg-ai-bg: #f1f8e9;     
            --msg-user-bg: #43a047;   
            --error-color: #e57373;
        }

        body {
            font-family: 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
            background: var(--bg-main);
            /* ëª¨ëˆˆì¢…ì´ íŒ¨í„´ */
            background-image: linear-gradient(0deg, transparent 24%, rgba(129, 199, 132, 0.1) 25%, rgba(129, 199, 132, 0.1) 26%, transparent 27%, transparent 74%, rgba(129, 199, 132, 0.1) 75%, rgba(129, 199, 132, 0.1) 76%, transparent 77%, transparent), linear-gradient(90deg, transparent 24%, rgba(129, 199, 132, 0.1) 25%, rgba(129, 199, 132, 0.1) 26%, transparent 27%, transparent 74%, rgba(129, 199, 132, 0.1) 75%, rgba(129, 199, 132, 0.1) 76%, transparent 77%, transparent);
            background-size: 50px 50px;
            color: var(--text-primary);
            margin: 0;
            display: flex;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* [ì¶”ê°€] ì™¼ìª½ ëŒ€ë‚˜ë¬´ ìˆ² */
        .bamboo-bg.left {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 30vw; /* í™”ë©´ ë„ˆë¹„ì˜ 30% ì°¨ì§€ */
            height: 50vh; /* í™”ë©´ ë†’ì´ì˜ 50% ì°¨ì§€ */
            background-image: url('https://images.unsplash.com/photo-1596323606046-a192809633e1?q=80&w=600&auto=format&fit=crop');
            background-size: cover;
            background-position: center bottom;
            background-repeat: no-repeat;
            z-index: -1;
            /* ìœ„ìª½ ìì—°ìŠ¤ëŸ½ê²Œ í˜ì´ë“œ ì•„ì›ƒ */
            mask-image: linear-gradient(to top, rgba(0,0,0,1) 40%, rgba(0,0,0,0) 100%);
            -webkit-mask-image: linear-gradient(to top, rgba(0,0,0,1) 40%, rgba(0,0,0,0) 100%);
        }

        /* [ì¶”ê°€] ì˜¤ë¥¸ìª½ ëŒ€ë‚˜ë¬´ ìˆ² */
        .bamboo-bg.right {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 30vw;
            height: 50vh;
            background-image: url('https://images.unsplash.com/photo-1515523916629-688755d496e5?q=80&w=600&auto=format&fit=crop');
            background-size: cover;
            background-position: left bottom;
            background-repeat: no-repeat;
            z-index: -1;
            /* ìœ„ìª½ ìì—°ìŠ¤ëŸ½ê²Œ í˜ì´ë“œ ì•„ì›ƒ */
            mask-image: linear-gradient(to top, rgba(0,0,0,1) 40%, rgba(0,0,0,0) 100%);
            -webkit-mask-image: linear-gradient(to top, rgba(0,0,0,1) 40%, rgba(0,0,0,0) 100%);
        }

        /* ëª¨ë°”ì¼ ëŒ€ì‘: í™”ë©´ ì¢ìœ¼ë©´ ëŒ€ë‚˜ë¬´ ìˆ¨ê¹€ (ì±„íŒ… ë°©í•´ ë°©ì§€) */
        @media (max-width: 800px) {
            .bamboo-bg { opacity: 0.3; width: 40vw; } /* ì‚´ì§ë§Œ ë³´ì´ê²Œ */
        }

        #app {
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            background: var(--panel-bg);
            position: relative;
            box-shadow: 0 10px 25px rgba(45, 90, 39, 0.15);
            border-radius: 20px;
            overflow: hidden;
            margin: 10px;
            border: 2px solid var(--accent-light);
            z-index: 1; 
        }

        /* í—¤ë”ë°” */
        .header-bar {
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 1.2rem;
            background: var(--accent-dark);
            color: white;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* ê´€ë¦¬ì ì•„ì´ì½˜ */
        .admin-icon {
            position: absolute;
            right: 15px;
            cursor: pointer;
            font-size: 1.2rem;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        .admin-icon:hover { opacity: 1; transform: rotate(90deg); transition: 0.3s; }

        /* ì±„íŒ…ì°½ */
        #chat-box {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background-color: #fff;
        }
        .msg {
            max-width: 85%;
            padding: 12px 18px;
            border-radius: 18px;
            line-height: 1.6;
            font-size: 0.95rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .msg.ai {
            align-self: flex-start;
            background: var(--msg-ai-bg);
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
            border: 1px solid var(--accent-light);
        }
        .msg.ai::before { content: 'ğŸ¼'; margin-right: 8px; }

        .msg.user {
            align-self: flex-end;
            background: var(--msg-user-bg);
            color: white;
            border-bottom-right-radius: 4px;
        }

        /* ì…ë ¥ì°½ ì˜ì—­ */
        #input-area {
            padding: 15px;
            background: var(--bg-main);
            border-top: 2px solid var(--accent-light);
            display: flex;
            gap: 10px;
        }
        input[type="text"] {
            flex: 1;
            padding: 12px;
            background: #ffffff;
            border: 2px solid var(--accent-light);
            color: var(--text-primary);
            border-radius: 25px;
            outline: none;
        }
        button {
            padding: 10px 24px;
            background: var(--accent-dark);
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            color: white;
            transition: background 0.2s;
        }
        button:hover { background: #3d7c36; }

        /* --- [ëª¨ë‹¬ ê³µí†µ ë””ìì¸] --- */
        .modal {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.98);
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            z-index: 10;
            padding-top: 20px;
            overflow-y: auto;
        }
        .hidden { display: none !important; }
        
        .number-form {
            width: 90%;
            max-width: 400px;
            padding-bottom: 50px;
        }
        
        .deck-section {
            background: #f1f8e9;
            border: 1px solid var(--accent-light);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .deck-section h3 {
            margin: 0 0 10px 0;
            color: var(--accent-dark);
            font-size: 1rem;
            display: flex;
            justify-content: space-between;
        }
        .deck-section span { font-size: 0.8rem; color: #666; font-weight: normal; }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        
        .input-item { display: flex; flex-direction: column; align-items: center; }
        .input-item label { font-size: 0.75rem; color: var(--accent-dark); margin-bottom: 4px; font-weight: bold; }
        
        .num-input {
            width: 100%;
            padding: 8px 0;
            text-align: center;
            border: 2px solid #ccc;
            border-radius: 8px;
            font-size: 1rem;
            outline: none;
            background: white;
            transition: border-color 0.2s;
        }
        .num-input:focus { border-color: var(--msg-user-bg); background: #e8f5e9; }
        .num-input.error { border-color: var(--error-color); background: #ffebee; }

        .submit-btn {
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            margin-top: 10px;
            background: var(--accent-dark);
            box-shadow: 0 4px 10px rgba(45, 90, 39, 0.3);
            color: white; border: none; border-radius: 8px; cursor: pointer;
        }
        .close-btn {
            width: 100%; background: #ccc; color: #333; margin-top:10px; padding: 10px; border:none; border-radius:8px; cursor: pointer;
        }

        /* ê¸°ë¡/ê´€ë¦¬ì ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .top-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.6);
            font-size: 0.8rem;
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
        }
        #history-btn { left: 15px; }
        
        /* ê´€ë¦¬ì ëª¨ë‹ˆí„°ë§ ìŠ¤íƒ€ì¼ */
        .admin-stat-box {
            background: #fff;
            border: 2px solid var(--accent-dark);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            width: 90%;
            text-align: left;
        }
        .log-item {
            font-size: 0.85rem;
            border-bottom: 1px solid #eee;
            padding: 8px 0;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f8e9; }
        ::-webkit-scrollbar-thumb { background: #a5d6a7; border-radius: 4px; }

    </style>
</head>
<body>

<div class="bamboo-bg left"></div>
<div class="bamboo-bg right"></div>

<div id="app">
    <div class="header-bar">
        <button id="history-btn" class="top-btn" onclick="showHistory()">ê¸°ë¡</button>
        ğŸ‹ ëŒ€ë‚˜ë¬´ íƒ€ë¡œ ğŸ‹
        <span class="admin-icon" onclick="openAdminCheck()">âš™ï¸</span>
    </div>
    <div id="chat-box">
        <div class="msg ai">ì–´ì„œì˜¤ì„¸ìš”! <br>ê¶ê¸ˆí•œ ì‚¬í•­ì„ ë‚¸ë‚˜!</div>
    </div>
    <div id="input-area">
        <input type="text" id="user-input" placeholder="ê³ ë¯¼ì„ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="if(event.key==='Enter') openNumberModal()">
        <button onclick="openNumberModal()">ì‹œì‘</button>
    </div>

    <div id="number-modal" class="modal hidden">
        <h2 style="color:var(--accent-dark); margin-bottom:5px;">ì¹´ë“œ ì„ íƒ</h2>
        <p style="color:#666; font-size:0.9rem; margin-bottom:20px;">ê° ë±ì˜ ë²”ìœ„ ë‚´ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>

        <div class="number-form">
            <div class="deck-section">
                <h3>Universal Waite <span>(1~78)</span></h3>
                <div class="input-grid">
                    <div class="input-item"><label>1.í˜„ì¬</label><input type="number" class="num-input waite" placeholder="ì„ íƒ"></div>
                    <div class="input-item"><label>2.ì¥ì• </label><input type="number" class="num-input waite" placeholder="ì„ íƒ"></div>
                    <div class="input-item"><label>3.ê³¼ì •</label><input type="number" class="num-input waite" placeholder="ì„ íƒ"></div>
                    <div class="input-item"><label>4.ê²°ê³¼</label><input type="number" class="num-input waite" placeholder="ì„ íƒ"></div>
                </div>
            </div>

            <div class="deck-section">
                <h3>Horoscope Belline <span>(1~53)</span></h3>
                <div class="input-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="input-item"><label>5.ì¡°ì–¸1</label><input type="number" class="num-input belline" placeholder="ì„ íƒ"></div>
                    <div class="input-item"><label>6.ì¡°ì–¸2</label><input type="number" class="num-input belline" placeholder="ì„ íƒ"></div>
                    <div class="input-item"><label>7.ì¡°ì–¸3</label><input type="number" class="num-input belline" placeholder="ì„ íƒ"></div>
                </div>
            </div>

            <div class="deck-section">
                <h3>Lenormand <span>(1~36)</span></h3>
                <div class="input-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="input-item"><label>8.ì‚¬ê±´1</label><input type="number" class="num-input lenormand" placeholder="ì„ íƒ"></div>
                    <div class="input-item"><label>9.ì‚¬ê±´2</label><input type="number" class="num-input lenormand" placeholder="ì„ íƒ"></div>
                    <div class="input-item"><label>10.ì‚¬ê±´3</label><input type="number" class="num-input lenormand" placeholder="ì„ íƒ"></div>
                </div>
            </div>

            <button class="submit-btn" onclick="processNumbers()">ê²°ê³¼ ë³´ê¸°</button>
            <button class="close-btn" onclick="closeModal('number-modal')">ì·¨ì†Œ</button>
        </div>
    </div>

    <div id="admin-modal" class="modal hidden">
        <h2 style="color:var(--accent-dark);">ğŸ”§ ê´€ë¦¬ì ëª¨ë‹ˆí„°ë§</h2>
        <div class="admin-stat-box">
            <h4>ğŸ“Š API / DB ìƒíƒœ</h4>
            <p>API Key Status: <span style="color:green; font-weight:bold;">Active</span></p>
            <p>ëˆ„ì  ìƒë‹´ ê±´ìˆ˜: <span id="total-count" style="font-weight:bold;">Loading...</span>ê±´</p>
        </div>
        
        <div class="admin-stat-box" style="flex:1; overflow:hidden; display:flex; flex-direction:column;">
            <h4>ğŸ“œ ìµœê·¼ ìš”ì²­ ë¡œê·¸ (Last 10)</h4>
            <div id="log-list" style="overflow-y:auto; flex:1;">
                </div>
        </div>
        <button class="close-btn" style="width:90%; margin-bottom:20px;" onclick="closeModal('admin-modal')">ë‹«ê¸°</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, getCountFromServer } 
            from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDuQDOi5wxabpqdqu-CJfdR-krk5Q08tBA",
        authDomain: "test-9da10.firebaseapp.com",
        projectId: "test-9da10",
        storageBucket: "test-9da10.firebasestorage.app",
        messagingSenderId: "578765851412",
        appId: "1:578765851412:web:5d9d30e09f8427d1a49001",
        measurementId: "G-LBY6NM2VGQ"
    };
   
    let db;
    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        console.log("ğŸ”¥ Firebase Connected!");
    } catch(e) {
        console.error("Firebase ì„¤ì • ì˜¤ë¥˜", e);
    }

    const DECKS = {
        waite: ["The Fool","The Magician","High Priestess","Empress","Emperor","Hierophant","Lovers","Chariot","Strength","Hermit","Wheel of Fortune","Justice","Hanged Man","Death","Temperance","Devil","Tower","Star","Moon","Sun","Judgement","World","Ace of Wands","Two of Wands","Three of Wands","Four of Wands","Five of Wands","Six of Wands","Seven of Wands","Eight of Wands","Nine of Wands","Ten of Wands","Page of Wands","Knight of Wands","Queen of Wands","King of Wands","Ace of Cups","King of Cups","Ace of Swords","King of Swords","Ace of Pentacles","King of Pentacles"],
        belline: ["Destiny","Success","Loss","Traffic","Union","Family","Amor","Sickness","Treachery","Money","Pleasure","Peace","Gifts","Discovery","Water","Fire","Island","Delayed","Ruins","Table"],
        lenormand: ["Rider","Clover","Ship","House","Tree","Clouds","Snake","Coffin","Bouquet","Scythe","Whip","Birds","Child","Fox","Bear","Stars","Stork","Dog","Tower","Garden","Mountain","Crossroad","Mice","Heart","Ring","Book","Letter","Man","Woman","Lily","Sun","Moon","Key","Fish","Anchor","Cross"]
    };

    let currentQuestion = "";
    // â˜… ì£¼ì˜: ì‹¤ì œ ë³¸ì¸ì˜ ìœ íš¨í•œ API í‚¤ì¸ì§€ ê¼­ í™•ì¸í•˜ì„¸ìš”!
    let apiKey = "AIzaSyB5ax1Xxo8nZo8fhZJXDYMOS5Ctkam_fxk"; 

    window.openNumberModal = () => {
        const input = document.getElementById('user-input');
        if(!input.value.trim()) return alert("ì§ˆë¬¸ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”!");
        
        currentQuestion = input.value;
        addMessage(currentQuestion, 'user');
        input.value = '';

        document.getElementById('number-modal').classList.remove('hidden');
        document.querySelectorAll('.num-input').forEach(el => {
            el.value = '';
            el.classList.remove('error');
        });
    };

    window.closeModal = (id) => {
        document.getElementById(id).classList.add('hidden');
    };

    // [ìˆ˜ì •] ì…ë ¥ê°’ ê²€ì¦ ë¡œì§ ê°•í™” (ë²”ìœ„ ì²´í¬)
    window.processNumbers = () => {
        // 1. ì…ë ¥ê°’ ìˆ˜ì§‘
        const wInputs = document.querySelectorAll('.waite');
        const bInputs = document.querySelectorAll('.belline');
        const lInputs = document.querySelectorAll('.lenormand');
        
        // 2. ìœ íš¨ì„± ê²€ì‚¬ (Mandatory & Range Check)
        let errorMsg = "";
        let hasError = false;

        const validate = (inputs, max, name) => {
            inputs.forEach(input => {
                const val = parseInt(input.value);
                if(!input.value || isNaN(val)) {
                    input.classList.add('error');
                    hasError = true;
                } else if (val < 1 || val > max) {
                    input.classList.add('error');
                    hasError = true;
                    if(!errorMsg.includes(name)) errorMsg += `[${name}] 1~${max} ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤.\n`;
                } else {
                    input.classList.remove('error');
                }
            });
        };

        validate(wInputs, 78, "ìœ ë‹ˆë²„ì…œ ì›¨ì´íŠ¸");
        validate(bInputs, 53, "í˜¸ë¡œìŠ¤ì½”í”„ ë²¨ë¦°");
        validate(lInputs, 36, "ë ˆë…¸ë¨¼ë“œ");

        if(hasError) {
            return alert(errorMsg || "ëª¨ë“  ì¹¸ì— ì˜¬ë°”ë¥¸ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        }

        // 3. ìˆ«ìë¥¼ ì¹´ë“œë¡œ ë³€í™˜ (Modulo ë¡œì§ ìœ ì§€í•˜ë˜, ì…ë ¥ì€ ë²”ìœ„ë‚´ë¡œ ì œí•œë¨)
        const getCard = (val, list) => {
            const num = parseInt(val);
            if(isNaN(num) || num < 1) return list[0]; 
            return list[(num - 1) % list.length];
        };

        const selectedCards = {
            waite: Array.from(wInputs).map(i => getCard(i.value, DECKS.waite)),
            belline: Array.from(bInputs).map(i => getCard(i.value, DECKS.belline)),
            lenormand: Array.from(lInputs).map(i => getCard(i.value, DECKS.lenormand))
        };

        closeModal('number-modal');
        callGemini(selectedCards);
    };

    // [ì¶”ê°€] ê´€ë¦¬ì ì ‘ì† ì²´í¬
    window.openAdminCheck = () => {
        const pw = prompt("ê´€ë¦¬ì ì•”í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
        if(pw === "5690") {
            document.getElementById('admin-modal').classList.remove('hidden');
            loadAdminStats();
        } else if (pw !== null) {
            alert("ì•”í˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }
    };

    // [ì¶”ê°€] ê´€ë¦¬ì í†µê³„ ë¡œë“œ
    async function loadAdminStats() {
        if(!db) return;
        const countSpan = document.getElementById('total-count');
        const logList = document.getElementById('log-list');
        
        // 1. ì´ ê°œìˆ˜ (Firestore ì§‘ê³„ ì¿¼ë¦¬ëŠ” ë¹„ìš© ë°œìƒí•˜ë¯€ë¡œ ë‹¨ìˆœíˆ ìµœê·¼ ë¡œê·¸ ê°€ì ¸ì˜¤ê¸°ë¡œ ëŒ€ì²´í•˜ê±°ë‚˜ ì‹¤ì œ êµ¬í˜„)
        // ì—¬ê¸°ì„œëŠ” ìµœê·¼ 10ê°œë§Œ ê°€ì ¸ì˜¤ê³  ê°œìˆ˜ëŠ” ìŠ¤ëƒ…ìƒ· ì‚¬ì´ì¦ˆë¡œ ì˜ˆì‹œ
        const q = query(collection(db, "tarot_readings"), orderBy("timestamp", "desc"), limit(20));
        const snapshot = await getDocs(q);
        
        countSpan.innerText = snapshot.size + "+ (Recent)"; 
        
        logList.innerHTML = "";
        snapshot.forEach(doc => {
            const data = doc.data();
            const date = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString() : "N/A";
            const div = document.createElement('div');
            div.className = "log-item";
            div.innerHTML = `<b>${date}</b><br>Q: ${data.question}`;
            logList.appendChild(div);
        });
    }

    window.showHistory = async () => {
        if(!db) return alert("DB ì—°ê²° ì‹¤íŒ¨");
        addMessage("ğŸ“œ ê³¼ê±°ì˜ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤...", 'ai');
        const q = query(collection(db, "tarot_readings"), orderBy("timestamp", "desc"), limit(3));
        const querySnapshot = await getDocs(q);
        querySnapshot.forEach((doc) => {
            const data = doc.data();
            addMessage(`[${new Date(data.timestamp?.toDate()).toLocaleDateString()}] <b>${data.question}</b><br><br>${data.cards}`, 'ai');
        });
    };

    function addMessage(html, type) {
        const box = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        div.innerHTML = type === 'ai' ? marked.parse(html) : html;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    async function callGemini(cards) {
        addMessage("ğŸ‹ íŒë‹¤ê°€ ë‹ê²ì˜ ìš´ëª…ì„ í•´ì„í•œë‹¤.....", 'ai');

        const systemPrompt = `
ë‹¹ì‹ ì€ ì§€ê¸ˆë¶€í„° ì „ë¬¸ íƒ€ë¡œ ë¦¬ë”ì…ë‹ˆë‹¤. ì•„ë˜ì˜ [ê·œì¹™]ê³¼ [ì¶œë ¥ í¬ë§·]ì„ ì—„ê²©íˆ ì¤€ìˆ˜í•˜ì—¬ ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ë‹µí•˜ì‹­ì‹œì˜¤.

## 1. ê¸°ë³¸ ì„¤ì •
ìš°ë¦¬ëŠ” ì‹¤ì œ ì˜¤í”„ë¼ì¸ ìƒë‹´ì‹¤ì— ìˆìŠµë‹ˆë‹¤.
ì‚¬ìš©ìëŠ” ì´ë¯¸ ì§ˆë¬¸ì„ í–ˆê³ , 3ê°œì˜ ë±(ìœ ë‹ˆë²„ì…œ ì›¨ì´íŠ¸, í˜¸ë¡œìŠ¤ì½”í”„ ë²¨ë¦°, ë ˆë…¸ë¨¼ë“œ)ì—ì„œ ìˆ«ìë¥¼ í†µí•´ ì¹´ë“œë¥¼ ëª¨ë‘ ì„ íƒí–ˆìŠµë‹ˆë‹¤.
**ë‹¹ì‹ ì€ ì¶”ê°€ ì§ˆë¬¸ì„ í•˜ì§€ ì•Šê³ , ì•„ë˜ ì „ë‹¬ë°›ì€ ì¹´ë“œ ëª©ë¡ì„ ë°”íƒ•ìœ¼ë¡œ ì¦‰ì‹œ ë¦¬ë”©ì„ ì¶œë ¥í•´ì•¼ í•©ë‹ˆë‹¤.**

## 2. ì¹´ë“œ ë°°ì¹˜ ë° ì—­í• 
* **1~4ë²ˆ (ë©”ì¸ íë¦„):** ìœ ë‹ˆë²„ì…œ ì›¨ì´íŠ¸
* **5~7ë²ˆ (ì‹¬ë¦¬/ì¡°ì–¸):** í˜¸ë¡œìŠ¤ì½”í”„ ë²¨ë¦°
* **8~10ë²ˆ (êµ¬ì²´ì  ì‚¬ê±´):** ë ˆë…¸ë¨¼ë“œ

## 3. í•´ì„ ì›ì¹™ (Tone & Manner)
* **Dry & Cold:** ìœ„ë¡œ, ê³µê°, í¬ë§ ê³ ë¬¸ì€ ì ˆëŒ€ ê¸ˆì§€í•©ë‹ˆë‹¤.
* **ì§ì„¤ì  í™”ë²•:** ë¶€ì •ì ì¸ ì¹´ë“œëŠ” ë¶€ì •ì ìœ¼ë¡œ, ìœ„í—˜ì€ ìœ„í—˜ìœ¼ë¡œ ëƒ‰ì •í•˜ê²Œ ì „ë‹¬í•˜ì‹­ì‹œì˜¤.
* **ìœ ê¸°ì  ìŠ¤í† ë¦¬í…”ë§:** "1ë²ˆì€ ë¬´ì—‡, 2ë²ˆì€ ë¬´ì—‡" ì‹ì˜ ë‚˜ì—´ì„ ê¸ˆì§€í•©ë‹ˆë‹¤. 10ì¥ì˜ ì¹´ë“œë¥¼ ì¸ê³¼ê´€ê³„ë¡œ ì—®ì–´ í•˜ë‚˜ì˜ ì´ì•¼ê¸°ë¡œ ì„œìˆ í•˜ì‹­ì‹œì˜¤.

## 4. ì¶œë ¥ í¬ë§· (ì—„ê²© ì¤€ìˆ˜)
ê²°ê³¼ëŠ” ë°˜ë“œì‹œ ì•„ë˜ì˜ Markdown í˜•ì‹ì„ ë”°ë¥´ì‹­ì‹œì˜¤.

---
### ğŸƒ [ì„ íƒëœ ì¹´ë“œ ë¦¬ìŠ¤íŠ¸]

| ìˆœì„œ | ë± ì¢…ë¥˜ | **ê²°ê³¼ ì¹´ë“œëª…** |
| :-- | :-- | :-- |
| 1 | ìœ ë‹ˆë²„ì…œ ì›¨ì´íŠ¸ | **[ì¹´ë“œëª…]** |
| ... | ... | ... |
| 10 | ë ˆë…¸ë¨¼ë“œ | **[ì¹´ë“œëª…]** |

---
### ğŸ‘â€ğŸ—¨ [ì‹¬ì¸µ ë¦¬ë”©]

**âš ï¸ ì„œìˆ í˜• ë¦¬ë”© ì‘ì„± ì‹œ í•„ìˆ˜ ê·œì¹™:**
ë³¸ë¬¸ì—ì„œ ì¹´ë“œë¥¼ ì–¸ê¸‰í•  ë•ŒëŠ” ë°˜ë“œì‹œ **í•œê¸€ëª…(ì˜ë¬¸ëª…)** í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ê³ , ì „ì²´ë¥¼ **Bold(\`**...**\`)** ì²˜ë¦¬í•˜ì—¬ ëˆˆì— ë„ê²Œ í•˜ì‹­ì‹œì˜¤.
(ì˜ˆ: ìƒí™©ì´ ì¢‹ê²Œ ì‹œì‘ë˜ë‚˜ **ê²€ 3(Three of Swords)**ê°€ ë‚˜ì˜¤ë©´ì„œ...)

#### 1. í•µì‹¬ íë¦„ ë° ë°©í•´ ìš”ì†Œ (Weight 1~4ë²ˆ)
*(ì›¨ì´íŠ¸ 4ì¥ì„ ì¤‘ì‹¬ìœ¼ë¡œ í˜„ì¬ ìƒí™©, ë°©í•´ë¬¼, íë¦„ì„ ë¶„ì„)*

#### 2. ì‹¬ë¦¬ì  ê¸°ì €ì™€ ìš´ê¸° (Belline 5~7ë²ˆ)
*(ì§ˆë¬¸ìì˜ ë‚´ë©´ ì‹¬ë¦¬ì™€ ì™¸ë¶€ ìš´ê¸°ì˜ ì‘ìš©ì„ ë¶„ì„)*

#### 3. í˜„ì‹¤ì  ì‚¬ê±´ê³¼ ë””í…Œì¼ (Lenormand 8~10ë²ˆ)
*(ë ˆë…¸ë¨¼ë“œ ì¹´ë“œë¥¼ í†µí•´ ë°œìƒí•  êµ¬ì²´ì  ì‚¬ê±´, ì¸ë¬¼, íƒ€ì´ë° ë¬˜ì‚¬)*

---
### ğŸ¯ [ìµœì¢… ê²°ë¡  ë° ì¡°ì–¸]
* **ìš”ì•½:** (í•œ ì¤„ ìš”ì•½)
* **ëƒ‰ì •í•œ ì¡°ì–¸:** (ê°ê´€ì ì´ê³  í˜„ì‹¤ì ì¸ í–‰ë™ ì§€ì¹¨)
`;

        const userContext = `
---
[ì‚¬ìš©ì ì…ë ¥ ë°ì´í„°]
**ì§ˆë¬¸:** "${currentQuestion}"

**ì„ íƒëœ ì¹´ë“œ ëª©ë¡ (ìˆœì„œëŒ€ë¡œ):**
1. ìœ ë‹ˆë²„ì…œ ì›¨ì´íŠ¸ (1~4ë²ˆ): ${cards.waite.join(', ')}
2. í˜¸ë¡œìŠ¤ì½”í”„ ë²¨ë¦° (5~7ë²ˆ): ${cards.belline.join(', ')}
3. ë ˆë…¸ë¨¼ë“œ (8~10ë²ˆ): ${cards.lenormand.join(', ')}

ìœ„ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì§€ê¸ˆ ë°”ë¡œ í•´ì„ì„ ì‹œì‘í•˜ì„¸ìš”.
`;

        const finalPrompt = systemPrompt + userContext;

        try {
            // gemini-3-pro-preview ëª¨ë¸ ì„¤ì • ìœ ì§€
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-preview:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text: finalPrompt }] }] })
            });

            const data = await res.json();

            // [ì—ëŸ¬ ì²˜ë¦¬]
            if (data.error) {
                throw new Error(`API Error: ${data.error.message}`);
            }
            if (!data.candidates || data.candidates.length === 0) {
                throw new Error("AIê°€ ì‘ë‹µí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (Safety Block ë˜ëŠ” ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜)");
            }

            const aiResponse = data.candidates[0].content.parts[0].text;
            
            document.querySelector('.msg.ai:last-child').remove();
            addMessage(aiResponse, 'ai');

            if(db) {
                await addDoc(collection(db, "tarot_readings"), {
                    question: currentQuestion,
                    cards: `W: ${cards.waite} / B: ${cards.belline} / L: ${cards.lenormand}`,
                    response: aiResponse,
                    timestamp: new Date()
                });
            }

        } catch (err) {
            document.querySelector('.msg.ai:last-child').remove();
            console.error(err);
            addMessage(`â›” <b>ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</b><br>ì›ì¸: ${err.message}<br><br>API í‚¤ë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ê±°ë‚˜ ì ì‹œ í›„ ì‹œë„í•´ì£¼ì„¸ìš”.`, 'ai');
        }
    }
</script>
</body>
</html>