<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HG AI Agents - Panda Tarot</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* --- [í…Œë§ˆ ì •ì˜] --- */
        :root {
            --bg-main: #e9f5ec;
            --panel-bg: #ffffff;
            --accent-dark: #2d5a27;
            --accent-light: #81c784;
            --text-primary: #1b3318;
            --card-back: #43a047;
            --card-selected: #ffd54f;
        }

        body {
            font-family: 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
            background: var(--bg-main);
            /* ëª¨ëˆˆì¢…ì´ íŒ¨í„´ */
            background-image: linear-gradient(0deg, transparent 24%, rgba(129, 199, 132, 0.1) 25%, rgba(129, 199, 132, 0.1) 26%, transparent 27%, transparent 74%, rgba(129, 199, 132, 0.1) 75%, rgba(129, 199, 132, 0.1) 76%, transparent 77%, transparent), linear-gradient(90deg, transparent 24%, rgba(129, 199, 132, 0.1) 25%, rgba(129, 199, 132, 0.1) 26%, transparent 27%, transparent 74%, rgba(129, 199, 132, 0.1) 75%, rgba(129, 199, 132, 0.1) 76%, transparent 77%, transparent);
            background-size: 50px 50px;
            color: var(--text-primary);
            margin: 0;
            display: flex;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* ë°°ê²½ ì¥ì‹ */
        .bamboo-bg {
            position: fixed; bottom: 0; width: 30vw; height: 50vh;
            background-size: cover; background-repeat: no-repeat;
            z-index: -1; pointer-events: none;
            mask-image: linear-gradient(to top, rgba(0,0,0,1) 40%, rgba(0,0,0,0) 100%);
            -webkit-mask-image: linear-gradient(to top, rgba(0,0,0,1) 40%, rgba(0,0,0,0) 100%);
        }
        .bamboo-bg.left { left: 0; background-image: url('https://images.unsplash.com/photo-1596323606046-a192809633e1?q=80&w=600&auto=format&fit=crop'); }
        .bamboo-bg.right { right: 0; background-image: url('https://images.unsplash.com/photo-1515523916629-688755d496e5?q=80&w=600&auto=format&fit=crop'); background-position: left bottom; }

        @media (max-width: 800px) { .bamboo-bg { opacity: 0.3; width: 40vw; } }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        #app {
            width: 100%; max-width: 600px;
            display: flex; flex-direction: column;
            background: var(--panel-bg);
            position: relative;
            box-shadow: 0 10px 25px rgba(45, 90, 39, 0.15);
            border-radius: 20px;
            overflow: hidden;
            margin: 10px;
            border: 2px solid var(--accent-light);
            z-index: 1;
        }

        /* í—¤ë” */
        .header-bar {
            padding: 15px; text-align: center; font-weight: bold; font-size: 1.2rem;
            background: var(--accent-dark); color: white;
            position: relative; display: flex; justify-content: center; align-items: center;
        }
        .top-btn {
            position: absolute; top: 50%; transform: translateY(-50%);
            background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.6);
            padding: 5px 10px; border-radius: 12px; font-size: 0.8rem; cursor: pointer;
        }
        #home-btn { left: 15px; }
        #history-btn { right: 50px; }
        .admin-trigger { position: absolute; right: 15px; cursor: pointer; opacity: 0.7; }

        /* ê³µí†µ ë·° ìŠ¤íƒ€ì¼ */
        .view-section {
            flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative;
        }

        /* 1. ì‹œì‘ í™”ë©´ */
        #start-view {
            align-items: center; justify-content: center; padding: 20px; text-align: center;
        }
        .panda-mascot {
            width: 150px; height: 150px; margin-bottom: 20px;
            /* ê¸°ë³¸ê°’: ê°™ì€ í´ë”ì˜ panda.png */
            background-image: url('./panda.png'); 
            background-size: cover; background-position: center;
            border-radius: 50%;
            border: 5px solid var(--accent-light);
            background-color: #fff;
        }
        #user-input {
            width: 80%; padding: 15px; margin-bottom: 15px;
            border: 2px solid var(--accent-light); border-radius: 25px;
            font-size: 1rem; text-align: center; outline: none;
        }
        .main-btn {
            padding: 12px 40px; background: var(--accent-dark); color: white;
            border: none; border-radius: 25px; font-size: 1.1rem; font-weight: bold;
            cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        .main-btn:active { transform: scale(0.98); }
        .main-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }

        /* 2. ì¹´ë“œ ê²Œì„ & ê²°ê³¼ í™”ë©´ */
        #game-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.98);
            z-index: 10;
        }
        .game-header { padding: 15px; text-align: center; background: #f1f8e9; border-bottom: 1px solid #ddd; }
        .card-table { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; align-content: flex-start; perspective: 1000px; }
        .card { width: 50px; height: 80px; background: var(--card-back); border-radius: 6px; border: 2px solid white; cursor: pointer; transition: 0.3s; position: relative; }
        .card::after { content: "ğŸ‹"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0.5; }
        .card.selected { transform: translateY(-15px) scale(1.1); background: var(--card-selected); z-index: 5; }
        .game-footer { padding: 15px; text-align: center; border-top: 1px solid #ddd; background: white; }

        /* ê²°ê³¼ í™”ë©´ */
        #result-view { background: #f9fbe7; }
        .result-scroll { flex: 1; overflow-y: auto; padding: 20px; }
        .speech-bubble { background: white; border-radius: 18px; padding: 20px; border: 1px solid #dcedc8; position: relative; }
        .copy-btn { position: absolute; top: 10px; right: 10px; background: #f1f8e9; border: 1px solid #ccc; border-radius: 5px; cursor: pointer; padding: 4px 8px; font-size: 12px; }

        /* 3. ê¸°ë¡(History) í™”ë©´ */
        #history-view { background: #fff; }
        .history-list { flex: 1; overflow-y: auto; padding: 10px; }
        .history-item {
            border: 1px solid #eee; border-radius: 10px; padding: 15px; margin-bottom: 10px;
            background: #f9f9f9; cursor: pointer; transition: 0.2s;
        }
        .history-item:hover { background: #e8f5e9; border-color: var(--accent-light); }
        .h-date { font-size: 0.8rem; color: #888; margin-bottom: 5px; }
        .h-q { font-weight: bold; color: var(--accent-dark); margin-bottom: 5px; }
        .h-preview { font-size: 0.9rem; color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* 4. ê´€ë¦¬ì(Admin) í™”ë©´ */
        #admin-view { padding: 20px; background: #f0f0f0; }
        .admin-form { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 5px; color: var(--accent-dark); }
        .form-group input { width: 90%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .preview-box { margin-top: 10px; text-align: center; }
        .preview-box img { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--accent-light); object-fit: cover; }

        /* ìœ í‹¸ë¦¬í‹° */
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.5s forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loading-dots::after { content: ' .'; animation: dots 1.5s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: ' .'; } 40% { content: ' ..'; } 60% { content: ' ...'; } 80%, 100% { content: ''; } }

    </style>
</head>
<body>

<div class="bamboo-bg left"></div>
<div class="bamboo-bg right"></div>

<div id="app">
    <div class="header-bar">
        <button id="home-btn" class="top-btn" onclick="showView('start-view')">ğŸ  í™ˆ</button>
        <span id="app-title-text">ëŒ€ë‚˜ë¬´ íƒ€ë¡œ</span>
        <button id="history-btn" class="top-btn" onclick="loadHistory()">ğŸ“œ ê¸°ë¡</button>
        <span class="admin-trigger" onclick="checkAdmin()">âš™ï¸</span>
    </div>

    <div id="start-view" class="view-section">
        <div class="panda-mascot" id="main-mascot"></div>
        <h2 id="main-title" style="color:var(--accent-dark); margin-bottom:5px;">ë¬´ì—‡ì´ ê¶ê¸ˆí•œê°€?</h2>
        <p id="main-subtitle" style="color:#666; font-size:0.9rem; margin-bottom:30px;">ë‹¹ì‹ ì˜ ê³ ë¯¼ì„ íŒë‹¤ê°€ ë“¤ì–´ì¤ë‹ˆë‹¤.</p>
        
        <input type="text" id="user-input" placeholder="ì˜ˆ: ì´ì§ìš´ì´ ì–´ë–¨ê¹Œìš”?" onkeypress="if(event.key==='Enter') startGame()">
        <button class="main-btn" onclick="startGame()">ìƒë‹´ ì‹œì‘í•˜ê¸°</button>
    </div>

    <div id="game-overlay" class="view-section hidden">
        <div class="game-header">
            <h3 id="stage-title">ì¹´ë“œ ì„ëŠ” ì¤‘...</h3>
            <p id="stage-desc">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
        </div>
        <div id="card-table" class="card-table"></div>
        <div class="game-footer">
            <button id="next-stage-btn" class="main-btn hidden" onclick="confirmSelection()">ë‹¤ìŒ ë‹¨ê³„ë¡œ</button>
            <span id="selection-count" style="font-weight:bold; color:var(--accent-dark);">0 / 4 ì„ íƒë¨</span>
        </div>
    </div>

    <div id="result-view" class="view-section hidden">
        <div class="result-scroll">
            <div style="text-align:right; margin-bottom:15px;">
                <span style="background:var(--accent-dark); color:white; padding:8px 15px; border-radius:15px; border-bottom-right-radius:2px; display:inline-block; max-width:80%;">
                    Q. <span id="display-question">ì§ˆë¬¸</span>
                </span>
            </div>
            <div style="display: flex; align-items: flex-end;">
                <div class="panda-mascot" style="width:50px; height:50px; margin:0 10px 0 0; border-width:2px;" id="result-mascot"></div>
                <div class="speech-bubble">
                    <button class="copy-btn" onclick="copyResult()">ğŸ“‹ ë³µì‚¬</button>
                    <div id="ai-response-content">
                        <span class="loading-dots" style="font-size:1.2rem; color:#666;">íŒë‹¤ê°€ ìš´ëª…ì„ í•´ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤</span>
                    </div>
                </div>
            </div>
        </div>
        <div style="padding:15px; border-top:1px solid #eee; background:white;">
            <button class="main-btn" style="width:100%" onclick="showView('start-view')">ìƒˆë¡œìš´ ê³ ë¯¼ ìƒë‹´í•˜ê¸°</button>
        </div>
    </div>

    <div id="history-view" class="view-section hidden">
        <h3 style="text-align:center; color:var(--accent-dark); margin:15px 0;">ğŸ“œ ê³¼ê±° ìƒë‹´ ê¸°ë¡</h3>
        <div id="history-list" class="history-list">
            <p style="text-align:center; color:#999; margin-top:50px;">ë¡œë”© ì¤‘...</p>
        </div>
    </div>

    <div id="admin-view" class="view-section hidden">
        <h3 style="text-align:center; color:var(--accent-dark);">ğŸ”§ ê´€ë¦¬ì ì„¤ì •</h3>
        <div class="admin-form">
            <div class="form-group">
                <label>ë©”ì¸ íƒ€ì´í‹€ ë¬¸êµ¬</label>
                <input type="text" id="admin-title-input" placeholder="ë¬´ì—‡ì´ ê¶ê¸ˆí•œê°€?">
            </div>
            <div class="form-group">
                <label>ì„œë¸Œ íƒ€ì´í‹€ ë¬¸êµ¬</label>
                <input type="text" id="admin-subtitle-input" placeholder="ë‹¹ì‹ ì˜ ê³ ë¯¼ì„ íŒë‹¤ê°€ ë“¤ì–´ì¤ë‹ˆë‹¤.">
            </div>
            <div class="form-group">
                <label>ì•„ì´ì½˜ ì´ë¯¸ì§€ URL (ê¸°ë³¸ê°’: ./panda.png)</label>
                <input type="text" id="admin-img-input" placeholder="./panda.png" oninput="previewAdminImg()">
                <div class="preview-box">
                    <p style="font-size:0.8rem; color:#666;">ë¯¸ë¦¬ë³´ê¸°</p>
                    <img id="admin-img-preview" src="./panda.png" onerror="this.src='./panda.png'">
                </div>
            </div>
            <button id="admin-save-btn" class="main-btn" style="width:100%; margin-top:10px;" onclick="saveAdminSettings()">ì €ì¥ ë° ì ìš©</button>
            <button style="width:100%; margin-top:10px; background:#ccc; border:none; padding:10px; border-radius:20px; cursor:pointer;" onclick="showView('start-view')">ë‚˜ê°€ê¸°</button>
        </div>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- Firebase ì„¤ì • ---
    const firebaseConfig = {
        apiKey: "AIzaSyDuQDOi5wxabpqdqu-CJfdR-krk5Q08tBA",
        authDomain: "test-9da10.firebaseapp.com",
        projectId: "test-9da10",
        storageBucket: "test-9da10.firebasestorage.app",
        messagingSenderId: "578765851412",
        appId: "1:578765851412:web:5d9d30e09f8427d1a49001",
        measurementId: "G-LBY6NM2VGQ"
    };
    
    let db;
    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        loadAdminConfig(); // ì•± ì‹œì‘ ì‹œ ì„¤ì • ë¡œë“œ
    } catch(e) { console.error("Firebase Init Error", e); }

    // --- ì „ì—­ ë³€ìˆ˜ ---
    const GEMINI_API_KEY = "AIzaSyB5ax1Xxo8nZo8fhZJXDYMOS5Ctkam_fxk"; 

    // ë± ë°ì´í„°
    const DECKS = {
        waite: { name: "ìœ ë‹ˆë²„ì…œ ì›¨ì´íŠ¸", count: 78, pick: 4 },
        belline: { name: "í˜¸ë¡œìŠ¤ì½”í”„ ë²¨ë¦°", count: 53, pick: 3 },
        lenormand: { name: "ë ˆë…¸ë¨¼ë“œ", count: 36, pick: 3 }
    };
    // ì¹´ë“œ ë¦¬ìŠ¤íŠ¸
    const FULL_LISTS = {
        waite: ["The Fool","The Magician","High Priestess","Empress","Emperor","Hierophant","Lovers","Chariot","Strength","Hermit","Wheel of Fortune","Justice","Hanged Man","Death","Temperance","Devil","Tower","Star","Moon","Sun","Judgement","World","Ace of Wands","Two of Wands","Three of Wands","Four of Wands","Five of Wands","Six of Wands","Seven of Wands","Eight of Wands","Nine of Wands","Ten of Wands","Page of Wands","Knight of Wands","Queen of Wands","King of Wands","Ace of Cups","Two of Cups","Three of Cups","Four of Cups","Five of Cups","Six of Cups","Seven of Cups","Eight of Cups","Nine of Cups","Ten of Cups","Page of Cups","Knight of Cups","Queen of Cups","King of Cups","Ace of Swords","Two of Swords","Three of Swords","Four of Swords","Five of Swords","Six of Swords","Seven of Swords","Eight of Swords","Nine of Swords","Ten of Swords","Page of Swords","Knight of Swords","Queen of Swords","King of Swords","Ace of Pentacles","Two of Pentacles","Three of Pentacles","Four of Pentacles","Five of Pentacles","Six of Pentacles","Seven of Pentacles","Eight of Pentacles","Nine of Pentacles","Ten of Pentacles","Page of Pentacles","Knight of Pentacles","Queen of Pentacles","King of Pentacles"],
        belline: ["Destiny","Success","Loss","Traffic","Union","Family","Amor","Sickness","Treachery","Money","Pleasure","Peace","Gifts","Discovery","Water","Fire","Island","Delayed","Ruins","Table","Intelligence","Volft","Enterprise","Elevation","Honors","Thought","Countryside","Presents","Letters","News","Chance","Light","Darkness","Love","Hate","Wedding","Divorce","Children","Parents","Home","Work","Change","Travel","Friendship","Enemy","Sorrow","Joy","Birth","Death","Beginning","End","Soul","Body"], 
        lenormand: ["Rider","Clover","Ship","House","Tree","Clouds","Snake","Coffin","Bouquet","Scythe","Whip","Birds","Child","Fox","Bear","Stars","Stork","Dog","Tower","Garden","Mountain","Crossroad","Mice","Heart","Ring","Book","Letter","Man","Woman","Lily","Sun","Moon","Key","Fish","Anchor","Cross"]
    };

    let gameState = {
        question: "",
        stage: 0, 
        selectedIndices: { waite: [], belline: [], lenormand: [] },
    };

    // --- ë·° ê´€ë¦¬ í•¨ìˆ˜ ---
    window.showView = (viewId) => {
        document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
        document.getElementById(viewId).classList.remove('hidden');
    };

    // --- 1. ê²Œì„ ë¡œì§ ---
    window.startGame = () => {
        const input = document.getElementById('user-input');
        if(!input.value.trim()) return alert("ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        
        gameState.question = input.value;
        gameState.selectedIndices = { waite: [], belline: [], lenormand: [] };
        
        document.getElementById('display-question').innerText = gameState.question;
        document.getElementById('ai-response-content').innerHTML = '<span class="loading-dots" style="font-size:1.2rem; color:#666;">íŒë‹¤ê°€ ìš´ëª…ì„ í•´ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤</span>';
        
        showView('game-overlay');
        startStage(0); 
    };

    function startStage(stageIndex) {
        gameState.stage = stageIndex;
        let deckType = "";
        let deckConfig = null;

        if(stageIndex === 0) { deckType = 'waite'; deckConfig = DECKS.waite; }
        else if(stageIndex === 1) { deckType = 'belline'; deckConfig = DECKS.belline; }
        else if(stageIndex === 2) { deckType = 'lenormand'; deckConfig = DECKS.lenormand; }
        else {
            finishGame();
            return;
        }

        const title = document.getElementById('stage-title');
        const desc = document.getElementById('stage-desc');
        const count = document.getElementById('selection-count');
        const btn = document.getElementById('next-stage-btn');
        const table = document.getElementById('card-table');

        btn.classList.add('hidden');
        table.innerHTML = ''; 
        count.innerText = `0 / ${deckConfig.pick} ì„ íƒë¨`;
        count.style.color = "var(--accent-dark)";

        title.innerText = `${deckConfig.name} ë±ì„ ì„ê³  ìˆìŠµë‹ˆë‹¤...`;
        desc.innerText = "ë§ˆìŒì„ ì°¨ë¶„íˆ í•˜ì„¸ìš”.";
        table.classList.add('shuffling');

        for(let i=0; i<30; i++) {
            const card = document.createElement('div');
            card.className = 'card';
            card.style.transform = `rotate(${Math.random()*20 - 10}deg)`;
            table.appendChild(card);
        }

        setTimeout(() => {
            table.classList.remove('shuffling');
            table.innerHTML = ''; 
            title.innerText = `${deckConfig.name} ì¹´ë“œ ì„ íƒ`;
            desc.innerText = `ì§ê´€ì ìœ¼ë¡œ ${deckConfig.pick}ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”.`;
            
            for(let i=0; i < deckConfig.count; i++) {
                const card = document.createElement('div');
                card.className = 'card fade-in';
                card.dataset.index = i;
                card.onclick = () => toggleCard(card, deckType, deckConfig.pick);
                card.style.animationDelay = `${i * 0.005}s`;
                table.appendChild(card);
            }
        }, 1000);
    }

    function toggleCard(cardEl, deckType, maxPick) {
        const currentList = gameState.selectedIndices[deckType];
        const index = parseInt(cardEl.dataset.index);

        if(cardEl.classList.contains('selected')) {
            cardEl.classList.remove('selected');
            const idx = currentList.indexOf(index);
            if(idx > -1) currentList.splice(idx, 1);
        } else {
            if(currentList.length >= maxPick) return alert(`ì´ ë±ì—ì„œëŠ” ${maxPick}ì¥ê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
            cardEl.classList.add('selected');
            currentList.push(index);
        }

        const countSpan = document.getElementById('selection-count');
        countSpan.innerText = `${currentList.length} / ${maxPick} ì„ íƒë¨`;
        
        const nextBtn = document.getElementById('next-stage-btn');
        if(currentList.length === maxPick) {
            nextBtn.classList.remove('hidden');
            countSpan.style.color = "green";
        } else {
            nextBtn.classList.add('hidden');
            countSpan.style.color = "var(--accent-dark)";
        }
    }

    window.confirmSelection = () => {
        startStage(gameState.stage + 1);
    };

    function finishGame() {
        showView('result-view');
        
        const finalCards = {
            waite: gameState.selectedIndices.waite.map(idx => FULL_LISTS.waite[idx % FULL_LISTS.waite.length] || "Card"),
            belline: gameState.selectedIndices.belline.map(idx => FULL_LISTS.belline[idx % FULL_LISTS.belline.length] || "Card"),
            lenormand: gameState.selectedIndices.lenormand.map(idx => FULL_LISTS.lenormand[idx % FULL_LISTS.lenormand.length] || "Card")
        };

        callGemini(finalCards);
    }

    // --- 2. Gemini API & ì €ì¥ ---
    async function callGemini(cards) {
        const resultDiv = document.getElementById('ai-response-content');
        
        const systemPrompt = `
ë‹¹ì‹ ì€ 'ëŒ€ë‚˜ë¬´ ìˆ²ì˜ í˜„ëª…í•œ íŒë‹¤' íƒ€ë¡œ ë¦¬ë”ì…ë‹ˆë‹¤.
ì§ˆë¬¸: "${gameState.question}"
ì¹´ë“œ: ì›¨ì´íŠ¸(${cards.waite}), ë²¨ë¦°(${cards.belline}), ë ˆë…¸ë¨¼ë“œ(${cards.lenormand})

**ë‹µë³€ í˜•ì‹(Markdown):**
1. **[ì„ íƒëœ ì¹´ë“œ]**: ì¹´ë“œ ëª©ë¡
2. **[íŒë‹¤ì˜ í•´ì„]**:
   - **í˜„ì¬(ì›¨ì´íŠ¸):** íë¦„ ë¶„ì„
   - **ì‹¬ë¦¬(ë²¨ë¦°):** ë‚´ë©´/ìš´ê¸°
   - **ë¯¸ë˜(ë ˆë…¸ë¨¼ë“œ):** ì‚¬ê±´/ì‹œê¸°
3. **[ëŒ€ë‚˜ë¬´ ìˆ²ì˜ ì¡°ì–¸]**: ëƒ‰ì² í•œ í•œ ì¤„ ì¡°ì–¸.
`;

        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-latest:generateContent?key=${GEMINI_API_KEY}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text: systemPrompt }] }] })
            });

            const data = await res.json();
            const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "í•´ì„ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
            
            resultDiv.innerHTML = marked.parse(aiText);

            // Firebase ì €ì¥
            if(db) {
                await addDoc(collection(db, "tarot_readings"), {
                    question: gameState.question,
                    response: aiText,
                    timestamp: new Date()
                });
            }

        } catch (err) {
            resultDiv.innerHTML = `âš ï¸ ì˜¤ë¥˜: ${err.message}`;
        }
    }

    // --- 3. ê³¼ê±° ê¸°ë¡ ë¡œì§ ---
    window.loadHistory = async () => {
        showView('history-view');
        const listEl = document.getElementById('history-list');
        listEl.innerHTML = '<p style="text-align:center; color:#666;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';

        if(!db) { listEl.innerHTML = "DB ì—°ê²° ì‹¤íŒ¨"; return; }

        try {
            const q = query(collection(db, "tarot_readings"), orderBy("timestamp", "desc"), limit(20));
            const snapshot = await getDocs(q);
            
            listEl.innerHTML = "";
            if(snapshot.empty) {
                listEl.innerHTML = '<p style="text-align:center;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            snapshot.forEach(doc => {
                const data = doc.data();
                const date = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString() : "ë‚ ì§œ ì—†ìŒ";
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `
                    <div class="h-date">${date}</div>
                    <div class="h-q">Q. ${data.question}</div>
                    <div class="h-preview">${data.response.replace(/<[^>]*>/g, '').substring(0, 40)}...</div>
                `;
                div.onclick = () => {
                    alert(`[ì§ˆë¬¸] ${data.question}\n\n[ê²°ê³¼ ìš”ì•½]\n${data.response.replace(/<[^>]*>/g, '').substring(0, 300)}...`);
                };
                listEl.appendChild(div);
            });
        } catch(e) {
            listEl.innerHTML = `ì˜¤ë¥˜ ë°œìƒ: ${e.message}`;
        }
    };

    // --- 4. ê´€ë¦¬ì ê¸°ëŠ¥ ---
    window.checkAdmin = () => {
        const pw = prompt("ê´€ë¦¬ì ì•”í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
        if(pw === "5690") {
            showView('admin-view');
            // ì…ë ¥ì°½ ì±„ìš°ê¸°
            document.getElementById('admin-title-input').value = document.getElementById('main-title').innerText;
            document.getElementById('admin-subtitle-input').value = document.getElementById('main-subtitle').innerText;
            
            let currentBg = document.getElementById('main-mascot').style.backgroundImage;
            let cleanUrl = currentBg.replace(/^url\(['"](.+)['"]\)$/, '$1');
            if(!cleanUrl || cleanUrl === 'none') cleanUrl = "./panda.png";
            
            document.getElementById('admin-img-input').value = cleanUrl;
            document.getElementById('admin-img-preview').src = cleanUrl;
        } else if(pw !== null) {
            alert("ì•”í˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
        }
    };

    window.previewAdminImg = () => {
        const url = document.getElementById('admin-img-input').value;
        document.getElementById('admin-img-preview').src = url || "./panda.png";
    };

    window.saveAdminSettings = async () => {
        if(!db) return alert("DB ì—°ê²° ì˜¤ë¥˜: ë¡œì»¬ íŒŒì¼(file://)ì´ ì•„ë‹Œ Live Serverë¡œ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.");
        
        const btn = document.getElementById('admin-save-btn');
        const originalText = btn.innerText;
        btn.innerText = "â³ ì €ì¥ ì¤‘...";
        btn.disabled = true;

        const newTitle = document.getElementById('admin-title-input').value;
        const newSubtitle = document.getElementById('admin-subtitle-input').value;
        const newImg = document.getElementById('admin-img-input').value || "./panda.png";

        try {
            await setDoc(doc(db, "settings", "config"), {
                title: newTitle,
                subtitle: newSubtitle,
                imgUrl: newImg
            }, { merge: true });

            // ì¦‰ì‹œ ë°˜ì˜ í›„ ìë™ ë‚˜ê°€ê¸°
            applyConfig(newTitle, newSubtitle, newImg);
            showView('start-view');
            
        } catch(e) {
            alert("âš ï¸ ì €ì¥ ì‹¤íŒ¨!\nì›ì¸: " + e.message + "\n\n(Firebase Console > Firestore Database > Rules íƒ­ì—ì„œ ì½ê¸°/ì“°ê¸° ê¶Œí•œì„ í—ˆìš©í–ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.)");
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    };

    // ì„¤ì • ì ìš© í•¨ìˆ˜
    async function loadAdminConfig() {
        if(!db) return;
        try {
            const docSnap = await getDoc(doc(db, "settings", "config"));
            if (docSnap.exists()) {
                const data = docSnap.data();
                applyConfig(data.title, data.subtitle, data.imgUrl);
            }
        } catch(e) { console.log("ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:", e); }
    }

    function applyConfig(title, subtitle, imgUrl) {
        if(title) {
            document.getElementById('main-title').innerText = title;
            document.getElementById('app-title-text').innerText = "ğŸ‹ " + title; 
        }
        if(subtitle) document.getElementById('main-subtitle').innerText = subtitle;
        if(imgUrl) {
            const url = `url('${imgUrl}')`;
            document.getElementById('main-mascot').style.backgroundImage = url;
            document.getElementById('result-mascot').style.backgroundImage = url;
        }
    }

    window.copyResult = () => {
        const text = document.getElementById('ai-response-content').innerText;
        navigator.clipboard.writeText(text).then(() => alert("ë³µì‚¬ ì™„ë£Œ!"));
    };

</script>
</body>
</html>
