<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HG AI Agents: Real Tarot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Do+Hyeon&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --app-bg-tarot: #e8f5e9; --app-bg-saju: #fffdf5; }
        body { background-color: #f9fafb; margin: 0; overflow: hidden; font-family: 'Noto Sans KR', sans-serif; display: flex; justify-content: center; align-items: center; height: 100dvh; }
        .hidden { display: none !important; }
        
        .app-container { width: 100%; max-width: 800px; height: 100dvh; display: flex; flex-direction: column; position: relative; background: #fff; overflow: hidden; box-shadow: 0 0 50px rgba(0,0,0,0.1); }

        /* ë¡œê·¸ì¸ í™”ë©´ (ìƒˆë¡œìš´ ë””ìì¸ ì ìš© + ì• ë‹ˆë©”ì´ì…˜) */
        #login-screen { position: absolute; inset: 0; z-index: 9999; background: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; overflow: hidden; }
        
        /* ë°°ê²½ íŒŒí‹°í´ ì• ë‹ˆë©”ì´ì…˜ (ì€ì€í•˜ê²Œ) */
        #login-screen::before, #login-screen::after { content: ''; position: absolute; width: 100%; height: 100%; background-image: radial-gradient(#e5e7eb 1px, transparent 1px); background-size: 20px 20px; opacity: 0.5; z-index: -1; }
        #login-screen::before { animation: particleMove 60s linear infinite; }
        #login-screen::after { animation: particleMove 90s linear infinite reverse; background-size: 30px 30px; opacity: 0.3; }
        @keyframes particleMove { from { transform: translateY(0) rotate(0deg); } to { transform: translateY(-100%) rotate(10deg); } }

        .login-header { text-align: center; margin-bottom: 3rem; position: relative; }
        .login-logo { width: 80px; height: 80px; margin-bottom: 1rem; animation: float-logo 3s ease-in-out infinite; }
        @keyframes float-logo { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        
        /* í°íŠ¸ í¬ê¸° í™•ëŒ€ ë° ì• ë‹ˆë©”ì´ì…˜ ë³µêµ¬ */
        .login-title { font-size: 3.5rem; font-weight: 700; color: #1f2937; margin-bottom: 0.5rem; font-family: 'Black Han Sans', sans-serif; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); animation: title-pop 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) both; }
        @keyframes title-pop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        .login-desc { color: #6b7280; font-size: 1.1rem; animation: fade-in 1s ease-out 0.5s both; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ì•„ì´ì½˜ ë©”ë‰´ ìŠ¤íƒ€ì¼ (ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€) */
        .icon-menu { display: flex; gap: 1.5rem; margin-bottom: 4rem; animation: slide-up 0.8s ease-out 0.3s both; }
        @keyframes slide-up { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .icon-item { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; cursor: default; opacity: 0.7; transition: 0.3s; }
        .icon-circle { width: 70px; height: 70px; border-radius: 24px; background: #f3f4f6; display: flex; justify-content: center; align-items: center; font-size: 2rem; color: #4b5563; transition: 0.3s; }
        .icon-label { font-size: 1rem; color: #4b5563; font-weight: 500; }
        .icon-item.active { opacity: 1; transform: translateY(-5px); }
        .icon-item.active .icon-circle { background: #eff6ff; color: #3b82f6; box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3), 0 4px 6px -2px rgba(59, 130, 246, 0.1); }
        .icon-item.active .icon-label { color: #3b82f6; }

        /* ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ (ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€) */
        .login-input-container { width: 100%; max-width: 700px; position: relative; animation: slide-up 0.8s ease-out 0.6s both; }
        .login-input { width: 100%; padding: 1.2rem 1.8rem; padding-right: 4rem; border: 2px solid #e5e7eb; border-radius: 9999px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); outline: none; font-size: 1.1rem; transition: 0.3s; }
        .login-input:focus { border-color: #3b82f6; box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3), 0 4px 6px -2px rgba(59, 130, 246, 0.1); }
        .login-btn-icon { position: absolute; right: 1.5rem; top: 50%; transform: translateY(-50%); color: #9ca3af; cursor: pointer; transition: 0.3s; font-size: 1.5rem; }
        .login-btn-icon:hover { color: #3b82f6; transform: translateY(-50%) scale(1.1); }

        /* í•˜ë‹¨ ì˜µì…˜ (ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€) */
        .login-options { display: flex; gap: 1rem; margin-top: 1.5rem; color: #6b7280; font-size: 1rem; animation: slide-up 0.8s ease-out 0.9s both; }
        .login-option-item { display: flex; align-items: center; gap: 0.5rem; background: #f9fafb; padding: 0.7rem 1.2rem; border-radius: 9999px; border: 1px solid #e5e7eb; transition: 0.3s; cursor: pointer; }
        .login-option-item:hover { background: #f3f4f6; border-color: #d1d5db; }

        /* ì„ íƒ í™”ë©´ (ìºë¦­í„°/í°íŠ¸ í¬ê¸° í™•ëŒ€ ë° ì• ë‹ˆë©”ì´ì…˜ ê°•í™”) */
        #selection-screen { position: absolute; inset: 0; background: #000; }
        .split-panel { position: absolute; top: 0; bottom: 0; width: 100%; height: 100%; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .panel-left { background: linear-gradient(135deg, #66bb6a 0%, #2e7d32 100%); clip-path: polygon(0 0, 60% 0, 40% 100%, 0 100%); left: 0; z-index: 10; }
        .panel-right { background: linear-gradient(135deg, #fff8e1 0%, #ffe0b2 100%); clip-path: polygon(60% 0, 100% 0, 100% 100%, 40% 100%); right: 0; z-index: 10; }
        
        /* ìºë¦­í„° í¬ê¸° ëŒ€í­ í™•ëŒ€ ë° ì• ë‹ˆë©”ì´ì…˜ ê°•í™” */
        .char-img { width: 250px; height: 250px; object-fit: contain; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.4)); animation: float-char 4s infinite ease-in-out; transition: 0.3s; }
        @keyframes float-char { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-20px) rotate(2deg); } }
        .panel-left:hover .char-img { transform: scale(1.15) rotate(-5deg); filter: drop-shadow(0 15px 25px rgba(0,0,0,0.5)); }
        .panel-right:hover .char-img { transform: scale(1.15) rotate(5deg); filter: drop-shadow(0 15px 25px rgba(0,0,0,0.5)); }
        
        /* í°íŠ¸ í¬ê¸° ëŒ€í­ í™•ëŒ€ */
        .title-badge { font-size: 3.5rem; font-family: 'Black Han Sans', sans-serif; padding: 10px 25px; border-radius: 15px; background: rgba(255,255,255,0.95); box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition: 0.3s; }
        .panel-left .title-badge { color: var(--text-panda); border: 4px solid var(--text-panda); }
        .panel-right .title-badge { color: var(--text-cat); border: 4px solid var(--text-cat); }
        .panel-left:hover .title-badge { transform: scale(1.1); box-shadow: 0 10px 25px rgba(103, 58, 183, 0.4); }
        .panel-right:hover .title-badge { transform: scale(1.1); box-shadow: 0 10px 25px rgba(255, 82, 82, 0.4); }
        
        /* ê³µí†µ í—¤ë”/ë²„íŠ¼ */
        .theme-tarot .app-container { background: var(--app-bg-tarot); } .theme-saju .app-container { background: var(--app-bg-saju); }
        #main-header { padding: 20px; display: flex; justify-content: space-between; color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 50; flex-shrink: 0; }
        #header-title { font-size: 1.5rem; font-family: 'Black Han Sans', sans-serif; } /* í—¤ë” íƒ€ì´í‹€ í¬ê¸° í™•ëŒ€ */
        .action-btn { border-radius: 30px; padding: 15px 20px; border: none; font-size: 1.3rem; font-family: 'Black Han Sans', sans-serif; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition: 0.2s; }
        .action-btn:active { transform: translateY(3px); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .action-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.3); }

        /* ì•± ë‚´ë¶€ ìºë¦­í„° ë° í°íŠ¸ í¬ê¸° í™•ëŒ€ */
        #tarot-mascot, #saju-mascot { width: 120px; height: 120px; border-width: 5px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        #tarot-title, #saju-title { font-size: 2.5rem; margin-bottom: 0.5rem; }
        #tarot-subtitle, #saju-subtitle { font-size: 1.1rem; }
        #tarot-input, #saju-input { font-size: 1.2rem; padding: 1.2rem; }

        /* íƒ€ë¡œ ì¹´ë“œ ì˜ì—­ */
        #tarot-card-table { 
            display: flex; flex-wrap: wrap; justify-content: center; align-content: flex-start; 
            gap: 6px; padding: 15px 10px; perspective: 1000px; 
            overflow-y: auto; flex: 1; width: 100%;
        }
        .tarot-card-face { 
            width: 50px; height: 80px; /* ì¹´ë“œ í¬ê¸° ì•½ê°„ í™•ëŒ€ */
            background: radial-gradient(circle at center, #512da8 0%, #311b92 100%); 
            border: 1px solid #d1c4e9; border-radius: 6px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); 
            display: flex; justify-content: center; align-items: center; 
            cursor: pointer; position: relative; transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.2s;
        }
        .tarot-card-face::after { content: 'ğŸ‹'; font-size: 1.5rem; opacity: 0.7; transition: 0.2s; }
        .tarot-card-face:hover { transform: translateY(-8px) scale(1.05); box-shadow: 0 8px 15px rgba(0,0,0,0.4); z-index: 10; }
        .tarot-card-face:hover::after { opacity: 1; transform: scale(1.1); }

        .card-selected { 
            background: radial-gradient(circle at center, #ffd54f 0%, #ff6f00 100%) !important; 
            border: 3px solid #fff !important; 
            transform: translateY(-15px) scale(1.2) !important; 
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.8), 0 10px 15px rgba(0,0,0,0.3) !important; 
            z-index: 50; 
        }
        .card-selected::after { content: 'âœ¨'; font-size: 1.8rem; animation: sparkle 1s infinite alternate; }
        @keyframes sparkle { from { opacity: 0.7; transform: scale(1); } to { opacity: 1; transform: scale(1.2); } }

        /* ì…”í”Œ ì• ë‹ˆë©”ì´ì…˜ */
        .deck-stack { position: relative; width: 110px; height: 170px; }
        .deck-card { position: absolute; inset: 0; background: #2e7d32; border: 4px solid #fff; border-radius: 10px; display: flex; justify-content: center; align-items: center; font-size: 2.5rem; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .deck-card::after { content: 'ğŸ‹'; }
        .shuffling .deck-card:nth-child(1) { animation: shf 0.4s infinite alternate; }
        .shuffling .deck-card:nth-child(2) { animation: shf 0.4s infinite alternate-reverse 0.1s; }
        @keyframes shf { from{transform:translateX(0) rotate(0deg)} to{transform:translateX(-20px) rotate(-8deg)} }

        /* Markdown */
        .markdown-body h1, .markdown-body h2 { border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 15px; color: #333; font-size: 1.5rem; font-weight: 700; }
        .markdown-body strong { color: #d32f2f; font-weight: 700; }
        .markdown-body p { margin-bottom: 1rem; line-height: 1.7; font-size: 1.05rem; }
    </style>
</head>
<body>

<div class="app-container">
    <div id="login-screen">
        <div class="login-header">
            <img src="https://cdn-icons-png.flaticon.com/512/4712/4712035.png" alt="Robot Logo" class="login-logo mx-auto">
            <h1 class="login-title">HG AI Agents</h1>
            <p class="login-desc">í•œë¯¸ê¸€ë¡œë²Œì˜ ë‹¤ì–‘í•œ AI íˆ´ì„ í•œê³³ì—ì„œ ì´ìš©í•˜ëŠ” í†µí•© í”Œë«í¼</p>
        </div>

        <div class="icon-menu">
            <div class="icon-item active">
                <div class="icon-circle"><i class="fas fa-comment-dots"></i></div>
                <span class="icon-label">AI ì±„íŒ…</span>
            </div>
            <div class="icon-item">
                <div class="icon-circle"><i class="fas fa-stars"></i></div>
                <span class="icon-label">Agentic AI</span>
            </div>
            <div class="icon-item">
                <div class="icon-circle"><i class="fas fa-rocket"></i></div>
                <span class="icon-label">AI ì—…ë¬´ì§€ì›</span>
            </div>
            <div class="icon-item">
                <div class="icon-circle"><i class="fas fa-globe"></i></div>
                <span class="icon-label">AI ë²ˆì—­</span>
            </div>
            <div class="icon-item">
                <div class="icon-circle"><i class="fas fa-image"></i></div>
                <span class="icon-label">AI ì´ë¯¸ì§€</span>
            </div>
        </div>

        <div class="login-input-container">
            <input type="password" id="login-api-key" class="login-input" placeholder="Gemini API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”... (Enterë¡œ ë¡œê·¸ì¸)" onkeypress="if(event.key==='Enter') attemptLogin()">
            <i class="fas fa-arrow-right login-btn-icon" onclick="attemptLogin()"></i>
        </div>

        <div class="login-options">
            <div class="login-option-item">
                <i class="fas fa-paperclip"></i>
                <span>AI ëª¨ë¸: Gemini 3 Pro (Preview)</span>
                <i class="fas fa-chevron-down text-xs"></i>
            </div>
            <div class="login-option-item">
                <span>Thinking ë ˆë²¨: ë†’ìŒ</span>
                <i class="fas fa-chevron-down text-xs"></i>
            </div>
        </div>
    </div>

    <div id="selection-screen" class="hidden">
        <div class="split-panel panel-left" onclick="selectMode('tarot')">
            <img id="intro-panda-img" src="./panda.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3069/3069172.png'" class="char-img">
            <div class="title-badge">íƒ€ë¡œ íŒë‹¤</div>
        </div>
        <div class="split-panel panel-right" onclick="selectMode('saju')">
            <img id="intro-cat-img" src="./cat.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/616/616430.png'" class="char-img">
            <div class="title-badge">ë¬´ì† ëƒ¥ì´</div>
        </div>
    </div>

    <div id="main-app-ui" class="hidden h-full flex flex-col relative font-[Do Hyeon]">
        <header id="main-header">
            <button onclick="goHome()" class="bg-white/20 px-4 py-2 rounded-full text-lg font-bold hover:bg-white/30 transition">â—€ ì²˜ìŒìœ¼ë¡œ</button>
            <h1 id="header-title">ì„œë¹„ìŠ¤</h1>
            <div class="flex gap-3">
                <button onclick="openHistory()" class="bg-white/20 px-4 py-2 rounded-full text-lg hover:bg-white/30 transition" title="ê¸°ë¡ ë³´ê¸°">ğŸ“œ</button>
                <button onclick="checkAdmin()" class="text-white opacity-80 hover:opacity-100 transition text-xl" title="ê´€ë¦¬ì ì„¤ì •">âš™ï¸</button>
            </div>
        </header>

        <div id="tarot-app" class="hidden flex-1 flex flex-col overflow-hidden relative">
            <div id="tarot-view-start" class="flex flex-col items-center justify-center text-center h-full p-6">
                <img id="tarot-mascot" src="./panda.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3069/3069172.png'" class="rounded-full border-green-600 bg-white object-cover mb-6">
                <h2 id="tarot-title" class="text-green-900 font-[Black Han Sans]">ë¦¬ì–¼ íƒ€ë¡œ ìƒë‹´ì†Œ</h2>
                <p id="tarot-subtitle" class="text-green-700 mb-8">ì§„ì§œ ë±ì„ ì„ì–´ ìš´ëª…ì„ ì ì¹©ë‹ˆë‹¤.</p>
                <input type="text" id="tarot-input" placeholder="ê³ ë¯¼ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì—°ì• ìš´)" class="w-full border-green-400 rounded-xl text-center mb-6 font-bold bg-white shadow-sm focus:border-green-600 transition" onkeypress="if(event.key==='Enter') startTarotFlow()">
                <button class="action-btn bg-green-600 text-white w-full" onclick="startTarotFlow()">ì¹´ë“œ ì„ê¸° ì‹œì‘</button>
            </div>

            <div id="tarot-shuffle-view" class="hidden h-full flex flex-col items-center justify-center bg-green-50">
                <div class="deck-stack shuffling mb-8">
                    <div class="deck-card"></div><div class="deck-card"></div>
                </div>
                <h3 class="text-2xl font-bold text-green-800 animate-pulse mb-2">ìš´ëª…ì„ ì„ëŠ” ì¤‘...</h3>
                <p class="text-base text-green-600">ë¬´ì‘ìœ„ ë°°ì—´ ìƒì„± ì¤‘ (Fisher-Yates Shuffle)</p>
            </div>

            <div id="tarot-view-game" class="hidden flex flex-col h-full overflow-hidden">
                <div class="bg-green-100 p-4 text-center shadow-sm z-10 flex-shrink-0 flex justify-between items-center">
                    <div class="text-left">
                        <div id="tarot-deck-name" class="font-bold text-green-900 text-lg">ë± ì´ë¦„</div>
                        <div id="tarot-deck-info" class="text-sm text-green-700">ì´ 00ì¥ ì¤‘ 0ì¥ ì„ íƒ</div>
                    </div>
                    <div id="tarot-selection-count" class="font-bold text-green-800 text-2xl">0 / 3</div>
                </div>
                
                <div id="tarot-card-table"></div>

                <div class="p-4 bg-white border-t border-gray-200 z-20 flex-shrink-0 shadow-[0_-5px_15px_rgba(0,0,0,0.1)]">
                    <button id="tarot-next-btn" class="action-btn bg-green-600 text-white w-full hidden" onclick="confirmTarotSelection()">ê²°ê³¼ í™•ì¸</button>
                    <div id="tarot-guide-msg" class="text-center text-gray-400 text-base font-bold py-3 animate-pulse">ì‹ ì¤‘í•˜ê²Œ ì¹´ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
                </div>
            </div>
        </div>

        <div id="saju-app" class="hidden flex-1 flex flex-col p-6 overflow-y-auto">
            <div id="saju-view-start" class="flex flex-col items-center justify-center text-center h-full">
                <img id="saju-mascot" src="./cat.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/616/616430.png'" class="rounded-full border-red-400 bg-white object-cover mb-6">
                <h2 id="saju-title" class="text-red-900 font-[Black Han Sans]">ì •í†µ ì‚¬ì£¼ ëª…ë¦¬</h2>
                <p id="saju-subtitle" class="text-red-700 mb-8">ë‹¹ì‹ ì˜ ìƒë…„ì›”ì¼ì„ ì•Œë ¤ì£¼ì„¸ìš”.</p>
                <div class="w-full bg-white p-6 rounded-xl border border-red-200 space-y-4 shadow-sm">
                    <input type="date" id="saju-date" class="w-full p-4 border rounded-lg bg-red-50 font-bold text-center text-lg focus:border-red-400 transition" value="2000-01-01">
                    <div class="flex gap-3">
                        <input type="time" id="saju-time" class="w-full p-4 border rounded-lg bg-red-50 text-center text-lg focus:border-red-400 transition" value="12:00">
                        <select id="saju-gender" class="w-full p-4 border rounded-lg bg-red-50 text-center text-lg font-bold focus:border-red-400 transition"><option value="male">ë‚¨ì„±</option><option value="female">ì—¬ì„±</option></select>
                    </div>
                    <button class="action-btn bg-red-500 text-white w-full mt-4" onclick="processSajuManse()">ë§Œì„¸ë ¥ í™•ì¸</button>
                </div>
            </div>
            <div id="saju-view-icebreak" class="hidden h-full flex flex-col">
                <div class="bg-white p-6 rounded-xl border-2 border-red-800 mb-6 text-center shadow-sm">
                    <div id="saju-pillars" class="flex justify-center gap-4 mb-4"></div>
                    <p id="saju-persona-msg" class="text-lg text-gray-700 font-medium leading-relaxed">ë¶„ì„ ì™„ë£Œ.</p>
                </div>
                <div class="mt-auto">
                    <input type="text" id="saju-input" placeholder="ê¶ê¸ˆí•œ ì ì„ ë¬¼ì–´ë³´ì„¸ìš” (ì˜ˆ: ì¬ë¬¼ìš´)" class="w-full p-4 border-2 border-red-800 rounded-xl mb-4 font-bold text-lg focus:border-red-600 transition">
                    <button class="action-btn bg-red-500 text-white w-full" onclick="startSajuConsult()">ìƒë‹´ í•˜ê¸°</button>
                </div>
            </div>
        </div>

        <div id="common-view-loading" class="hidden absolute inset-0 bg-white/95 z-50 flex flex-col items-center justify-center text-center p-8">
            <img id="loading-img" src="" class="w-32 h-32 rounded-full mb-6 animate-bounce border-4 border-gray-300 shadow-lg">
            <p id="loading-text" class="text-2xl font-bold text-gray-700 animate-pulse">AI ë¶„ì„ ì¤‘...</p>
        </div>
        <div id="common-view-result" class="hidden absolute inset-0 bg-white z-40 flex flex-col p-6 overflow-y-auto">
            <div class="text-right mb-4"><button onclick="resetCurrentMode()" class="text-lg text-gray-500 underline hover:text-gray-700 transition">ì²˜ìŒìœ¼ë¡œ</button></div>
            <div class="bg-gray-50 p-5 rounded-xl border border-gray-200 mb-5 shadow-sm"><span class="font-bold text-gray-600 text-xl">Q.</span> <span id="result-question" class="font-bold text-xl">ì§ˆë¬¸</span></div>
            <div class="flex-1 bg-white border border-gray-300 rounded-xl p-6 relative overflow-y-auto shadow-inner">
                <div id="result-content" class="markdown-body text-lg leading-relaxed text-gray-800"></div>
            </div>
            <button class="action-btn bg-gray-800 text-white w-full mt-5" onclick="resetCurrentMode()">ë‹«ê¸°</button>
        </div>
        <div id="common-view-history" class="hidden absolute inset-0 bg-white z-50 flex flex-col p-6">
            <h3 class="text-center font-bold text-2xl mb-6 font-[Black Han Sans]">ìƒë‹´ ê¸°ë¡</h3>
            <div id="history-list" class="flex-1 overflow-y-auto space-y-4 p-2"></div>
            <button class="action-btn bg-gray-200 text-gray-800 w-full mt-4 hover:bg-gray-300" onclick="document.getElementById('common-view-history').classList.add('hidden')">ë‹«ê¸°</button>
        </div>
    </div>
    
    <div id="admin-modal" class="hidden absolute inset-0 bg-black/80 z-[100] flex items-center justify-center p-6">
        <div class="bg-white p-8 rounded-2xl w-full max-w-md shadow-2xl">
            <h3 class="font-bold text-2xl mb-6 font-[Black Han Sans]">ì„¤ì •</h3>
            <div class="mb-6">
                <label class="block text-sm font-bold text-gray-700 mb-2">ì•„ì´ì½˜ ë³€ê²½</label>
                <div class="flex items-center gap-4">
                    <img id="admin-img-preview" class="w-20 h-20 rounded-full border-2 border-gray-300 shadow-sm">
                    <input type="file" id="admin-file-input" accept="image/*" class="text-sm" onchange="previewImage(this)">
                </div>
            </div>
            <button onclick="saveAdmin()" class="action-btn bg-blue-600 text-white w-full text-lg mb-3">ì €ì¥</button>
            <button onclick="document.getElementById('admin-modal').classList.add('hidden')" class="w-full py-3 text-lg text-gray-500 hover:text-gray-700 transition">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, doc, setDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const tarotConfig = { apiKey: "AIzaSyDuQDOi5wxabpqdqu-CJfdR-krk5Q08tBA", projectId: "test-9da10", appId: "1:578765851412:web:5d9d30e09f8427d1a49001" };
    const sajuConfig = { apiKey: "AIzaSyB-y3inMOTdj48gwlh0eftUc_YfyNTeJmc", projectId: "sajutest-e4eaa", appId: "1:753725539148:web:f2d67dd6b3adf6514345e9" };
    let dbTarot, dbSaju;
    try { dbTarot = getFirestore(initializeApp(tarotConfig, "tarotApp")); dbSaju = getFirestore(initializeApp(sajuConfig, "sajuApp")); } catch(e){}

    let currentMode = null; 
    let gameState = { stage: 0, deck: [], selections: [], question: "" }; // deck ë°°ì—´ì— ì‹¤ì œ ì¹´ë“œ ì •ë³´ ì €ì¥
    let sajuState = { pillars: [], info: {} };
    let uploadedImageBase64 = null; 
    let userApiKey = null; 

    // --- Data: ì‹¤ì œ íƒ€ë¡œ ë± ë°ì´í„° ---
    const DECK_DATA = {
        waite: {
            name: "ìœ ë‹ˆë²„ì…œ ì›¨ì´íŠ¸", count: 78, pick: 3,
            cards: [
                "0.ê´‘ëŒ€(The Fool)", "1.ë§ˆë²•ì‚¬(The Magician)", "2.ì—¬ì‚¬ì œ(The High Priestess)", "3.ì—¬í™©ì œ(The Empress)", "4.í™©ì œ(The Emperor)", 
                "5.êµí™©(The Hierophant)", "6.ì—°ì¸(The Lovers)", "7.ì „ì°¨(The Chariot)", "8.í˜(Strength)", "9.ì€ë‘”ì(The Hermit)", 
                "10.ìš´ëª…ì˜ ìˆ˜ë ˆë°”í€´(Wheel of Fortune)", "11.ì •ì˜(Justice)", "12.ë§¤ë‹¬ë¦° ì‚¬ëŒ(The Hanged Man)", "13.ì£½ìŒ(Death)", "14.ì ˆì œ(Temperance)", 
                "15.ì•…ë§ˆ(The Devil)", "16.íƒ‘(The Tower)", "17.ë³„(The Star)", "18.ë‹¬(The Moon)", "19.íƒœì–‘(The Sun)", "20.ì‹¬íŒ(Judgement)", "21.ì„¸ê³„(The World)",
                // Wands
                "Ace of Wands", "2 of Wands", "3 of Wands", "4 of Wands", "5 of Wands", "6 of Wands", "7 of Wands", "8 of Wands", "9 of Wands", "10 of Wands", "Page of Wands", "Knight of Wands", "Queen of Wands", "King of Wands",
                // Cups
                "Ace of Cups", "2 of Cups", "3 of Cups", "4 of Cups", "5 of Cups", "6 of Cups", "7 of Cups", "8 of Cups", "9 of Cups", "10 of Cups", "Page of Cups", "Knight of Cups", "Queen of Cups", "King of Cups",
                // Swords
                "Ace of Swords", "2 of Swords", "3 of Swords", "4 of Swords", "5 of Swords", "6 of Swords", "7 of Swords", "8 of Swords", "9 of Swords", "10 of Swords", "Page of Swords", "Knight of Swords", "Queen of Swords", "King of Swords",
                // Pentacles
                "Ace of Pentacles", "2 of Pentacles", "3 of Pentacles", "4 of Pentacles", "5 of Pentacles", "6 of Pentacles", "7 of Pentacles", "8 of Pentacles", "9 of Pentacles", "10 of Pentacles", "Page of Pentacles", "Knight of Pentacles", "Queen of Pentacles", "King of Pentacles"
            ]
        },
        belline: {
            name: "í˜¸ë¡œìŠ¤ì½”í”„ ë²¨ë¦°", count: 53, pick: 3,
            cards: Array.from({length:53}, (_,i)=>`Belline Card No.${i+1}`) // ì‹¤ì œ ì´ë¦„ ëŒ€ì‹  ë²ˆí˜¸ë¡œ ì²˜ë¦¬ (AIê°€ í•´ì„ ê°€ëŠ¥)
        },
        lenormand: {
            name: "ë ˆë…¸ë¨¼ë“œ", count: 36, pick: 3,
            cards: [
                "1.Rider", "2.Clover", "3.Ship", "4.House", "5.Tree", "6.Clouds", "7.Snake", "8.Coffin", "9.Bouquet", "10.Scythe",
                "11.Whip", "12.Birds", "13.Child", "14.Fox", "15.Bear", "16.Stars", "17.Stork", "18.Dog", "19.Tower", "20.Garden",
                "21.Mountain", "22.Crossroad", "23.Mice", "24.Heart", "25.Ring", "26.Book", "27.Letter", "28.Gentleman", "29.Lady", "30.Lily",
                "31.Sun", "32.Moon", "33.Key", "34.Fish", "35.Anchor", "36.Cross"
            ]
        }
    };

    // --- Shuffling Algorithm (Fisher-Yates) ---
    function shuffleArray(array) {
        const arr = [...array]; // ë³µì‚¬ë³¸ ìƒì„±
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    }

    // --- Main Logic ---
    window.attemptLogin = () => {
        userApiKey = document.getElementById('login-api-key').value;
        if(!userApiKey) return alert("API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('selection-screen').classList.remove('hidden');
        if(dbTarot) loadConfig('tarot', true); if(dbSaju) loadConfig('saju', true);
    };

    window.selectMode = (mode) => {
        currentMode = mode;
        document.getElementById('selection-screen').classList.add('hidden');
        document.getElementById('main-app-ui').classList.remove('hidden');
        document.body.className = ''; document.body.classList.add(`theme-${mode}`);
        document.getElementById('main-header').style.background = mode==='tarot' ? '#2e7d32':'#c62828';
        document.getElementById('header-title').innerText = mode==='tarot' ? 'íƒ€ë¡œ ìƒë‹´ì†Œ' : 'ì‚¬ì£¼ ëª…ë¦¬';
        
        document.getElementById('tarot-app').classList.add('hidden');
        document.getElementById('saju-app').classList.add('hidden');
        document.getElementById(`${mode}-app`).classList.remove('hidden');
        
        if(mode === 'tarot') {
            document.getElementById('tarot-view-start').classList.remove('hidden');
            document.getElementById('tarot-view-game').classList.add('hidden');
        }
        loadConfig(mode);
    };

    window.goHome = () => {
        document.getElementById('main-app-ui').classList.add('hidden');
        document.getElementById('selection-screen').classList.remove('hidden');
    };

    window.resetCurrentMode = () => {
        document.getElementById('common-view-result').classList.add('hidden');
        if(currentMode==='tarot') {
            document.getElementById('tarot-view-start').classList.remove('hidden');
            document.getElementById('tarot-view-game').classList.add('hidden');
        } else {
            document.getElementById('saju-input').value = "";
        }
    };

    // --- Tarot Game Flow ---
    const TAROT_SEQUENCE = ['waite', 'belline', 'lenormand']; // ì§„í–‰ ìˆœì„œ

    window.startTarotFlow = () => {
        const q = document.getElementById('tarot-input').value;
        if(!q) return alert("ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”");
        gameState.question = q;
        gameState.finalSelections = {}; // { waite: [card1, card2], ... }
        runStage(0);
    };

    function runStage(idx) {
        if(idx >= TAROT_SEQUENCE.length) { showFinalResult(); return; }
        
        gameState.stageIdx = idx;
        const deckKey = TAROT_SEQUENCE[idx];
        const deckInfo = DECK_DATA[deckKey];
        
        // 1. ì…”í”Œ í™”ë©´ í‘œì‹œ
        document.getElementById('tarot-view-start').classList.add('hidden');
        document.getElementById('tarot-view-game').classList.add('hidden');
        document.getElementById('tarot-shuffle-view').classList.remove('hidden');
        
        // 2. ì‹¤ì œ ë± ìƒì„± ë° ì…”í”Œ (Real Logic)
        gameState.currentDeck = shuffleArray(deckInfo.cards); // ì„ì¸ ì¹´ë“œ ë°°ì—´
        gameState.currentPicks = [];
        
        setTimeout(() => {
            document.getElementById('tarot-shuffle-view').classList.add('hidden');
            document.getElementById('tarot-view-game').classList.remove('hidden');
            renderTable(deckInfo);
        }, 1500);
    }

    function renderTable(info) {
        document.getElementById('tarot-deck-name').innerText = info.name;
        document.getElementById('tarot-deck-info').innerText = `ì´ ${info.count}ì¥ ì¤‘ ${info.pick}ì¥ ì„ íƒ`;
        updateCount(0, info.pick);
        document.getElementById('tarot-next-btn').classList.add('hidden');
        document.getElementById('tarot-guide-msg').classList.remove('hidden');

        const table = document.getElementById('tarot-card-table');
        table.innerHTML = "";
        
        // ì„ì¸ ë±ì„ ê¸°ë°˜ìœ¼ë¡œ ì¹´ë“œ ìƒì„±
        gameState.currentDeck.forEach((cardName, i) => {
            const card = document.createElement('div');
            card.className = "tarot-card-face";
            // ì¤‘ìš”: í´ë¦­ ì‹œ ì´ ì¹´ë“œì˜ ì‹¤ì œ ì´ë¦„(cardName)ì„ ì‚¬ìš©í•¨
            card.dataset.realValue = cardName; 
            card.dataset.idx = i;
            
            // ì‹œê°ì  ë‚œìˆ˜ (ê¸°ìš¸ê¸°)
            card.style.transform = `rotate(${Math.random()*4 - 2}deg)`;
            
            card.onclick = () => {
                const list = gameState.currentPicks;
                if(card.classList.contains('card-selected')) {
                    card.classList.remove('card-selected');
                    const idx = list.indexOf(cardName);
                    if(idx > -1) list.splice(idx, 1);
                } else {
                    if(list.length >= info.pick) return alert(`ì´ ë±ì—ì„œëŠ” ${info.pick}ì¥ë§Œ ë½‘ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                    card.classList.add('card-selected');
                    list.push(cardName);
                }
                
                updateCount(list.length, info.pick);
                if(list.length === info.pick) {
                    document.getElementById('tarot-next-btn').classList.remove('hidden');
                    document.getElementById('tarot-guide-msg').classList.add('hidden');
                } else {
                    document.getElementById('tarot-next-btn').classList.add('hidden');
                    document.getElementById('tarot-guide-msg').classList.remove('hidden');
                }
            };
            table.appendChild(card);
        });
    }

    function updateCount(c, m) { document.getElementById('tarot-selection-count').innerText = `${c} / ${m}`; }

    window.confirmTarotSelection = () => {
        const currentKey = TAROT_SEQUENCE[gameState.stageIdx];
        gameState.finalSelections[currentKey] = [...gameState.currentPicks]; // ì„ íƒ ì €ì¥
        runStage(gameState.stageIdx + 1); // ë‹¤ìŒ ë±ìœ¼ë¡œ
    };

    async function showFinalResult() {
        document.getElementById('common-view-loading').classList.remove('hidden');
        document.getElementById('loading-text').innerText = "íŒë‹¤ê°€ ì„ íƒëœ ì¹´ë“œë¥¼ ì½ê³  ìˆìŠµë‹ˆë‹¤...";
        document.getElementById('loading-img').src = document.getElementById('tarot-mascot').src;

        // í”„ë¡¬í”„íŠ¸ ìƒì„± (ì‹¤ì œ ë½‘ì€ ì¹´ë“œ ì •ë³´ ì „ë‹¬)
        const s = gameState.finalSelections;
        const prompt = `
        [íƒ€ë¡œ ì ìˆ ]
        ì§ˆë¬¸: "${gameState.question}"
        
        ì‚¬ìš©ìê°€ ì‹¤ì œë¡œ ë½‘ì€ ì¹´ë“œ ëª©ë¡ (ì ˆëŒ€ ë¬´ì‘ìœ„ ìƒì„±ì´ ì•„ë‹˜, ì´ ì¹´ë“œë¥¼ í•´ì„í•´ì•¼ í•¨):
        1. ìœ ë‹ˆë²„ì…œ ì›¨ì´íŠ¸ (ìƒí™©): ${s.waite.join(', ')}
        2. í˜¸ë¡œìŠ¤ì½”í”„ ë²¨ë¦° (ì‹¬ë¦¬): ${s.belline.join(', ')}
        3. ë ˆë…¸ë¨¼ë“œ (ë¯¸ë˜): ${s.lenormand.join(', ')}
        
        ìš”ì²­:
        ìœ„ ì¹´ë“œë“¤ì˜ ìƒì§•ê³¼ ì˜ë¯¸ë¥¼ ì •í™•íˆ ì¡°í•©í•˜ì—¬ ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€ì„ í•´ì£¼ì„¸ìš”.
        ë§íˆ¬: ì¹œì ˆí•˜ê³  ì‹ ë¹„ë¡œìš´ íŒë‹¤ ë§íˆ¬ ("~ë‹¤ íŒë‹¤").
        í˜•ì‹: Markdown.
        1. **ğŸ‹ ë‹¹ì‹ ì´ ë½‘ì€ ëŒ€ë‚˜ë¬´ ì (ì¹´ë“œ)**: (ì¹´ë“œ ì´ë¦„ë“¤ ë‚˜ì—´)
        2. **ğŸ¼ íŒë‹¤ì˜ ê¹Šì€ í•´ì„**: (ê° ë±ì˜ ì˜ë¯¸ë¥¼ ì—°ê²°í•˜ì—¬ í•´ì„)
        3. **ğŸ ëŒ€ë‚˜ë¬´ ìˆ²ì˜ ì¡°ì–¸**: (êµ¬ì²´ì ì¸ í–‰ë™ ì§€ì¹¨)
        `;

        try {
            const text = await callGemini(prompt);
            document.getElementById('common-view-loading').classList.add('hidden');
            document.getElementById('common-view-result').classList.remove('hidden');
            document.getElementById('result-question').innerText = gameState.question;
            document.getElementById('result-content').innerHTML = marked.parse(text);
            
            if(dbTarot) addDoc(collection(dbTarot, "tarot_readings"), { 
                question: gameState.question, 
                cards: gameState.finalSelections,
                response: text, 
                timestamp: new Date() 
            });
        } catch(e) { alert(e.message); }
    }

    // --- Saju Logic ---
    window.processSajuManse = async () => {
        sajuState.info = { date: document.getElementById('saju-date').value, time: document.getElementById('saju-time').value, gender: document.getElementById('saju-gender').value };
        document.getElementById('common-view-loading').classList.remove('hidden');
        try {
            const res = await callGemini(`ì‚¬ì£¼ë§Œì„¸ë ¥JSON. ì •ë³´:${JSON.stringify(sajuState.info)}. ì¶œë ¥:{"pillars":["ê°‘ì","ì„ì¶•","ë³‘ì¸","ì •ë¬˜"],"colors":["wood","earth","fire","wood"]}`, true);
            const data = JSON.parse(res);
            sajuState.pillars = data.pillars;
            const el = document.getElementById('saju-pillars'); el.innerHTML="";
            data.pillars.forEach((p,i)=> el.innerHTML+=`<div class="w-14 h-14 rounded-full flex items-center justify-center text-white text-lg font-bold shadow-md ${data.colors[i]}">${p}</div>`);
            document.getElementById('common-view-loading').classList.add('hidden');
            document.getElementById('saju-view-icebreak').classList.remove('hidden');
        } catch(e){ document.getElementById('common-view-loading').classList.add('hidden'); }
    }

    window.startSajuConsult = async () => {
        const q = document.getElementById('saju-input').value;
        if(!q) return alert("ì…ë ¥í•˜ì„¸ìš”");
        document.getElementById('common-view-loading').classList.remove('hidden');
        const prompt = `ì‚¬ì£¼:${sajuState.pillars.join(',')}. ì§ˆë¬¸:${q}. ê³ ì–‘ì´ë§íˆ¬. Markdowní•´ì„.`;
        try {
            const text = await callGemini(prompt);
            document.getElementById('common-view-loading').classList.add('hidden');
            document.getElementById('common-view-result').classList.remove('hidden');
            document.getElementById('result-question').innerText = q;
            document.getElementById('result-content').innerHTML = marked.parse(text);
            if(dbSaju) addDoc(collection(dbSaju, "saju_history"), { question: q, answer: text, date: new Date().toISOString() });
        } catch(e){}
    }

    // --- API & Utils ---
    async function callGemini(text, isJson=false) {
        if(!userApiKey) throw new Error("API Key ì—†ìŒ");
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${userApiKey}`;
        const body = { contents: [{ parts: [{ text }] }], generationConfig: isJson?{responseMimeType:"application/json"}:{} };
        const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
        const json = await res.json();
        return json.candidates[0].content.parts[0].text;
    }

    // History & Admin functions (Simplified for length)
    window.openHistory = async () => {
        const list = document.getElementById('history-list');
        document.getElementById('common-view-history').classList.remove('hidden');
        list.innerHTML = "ë¡œë”©...";
        if(!dbTarot) return list.innerHTML = "DB ì—†ìŒ";
        const db = currentMode==='tarot'?dbTarot:dbSaju;
        const col = currentMode==='tarot'?'tarot_readings':'saju_history';
        const snap = await getDocs(query(collection(db, col), orderBy(currentMode==='tarot'?'timestamp':'date', 'desc'), limit(10)));
        list.innerHTML="";
        snap.forEach(d=>{
            const div=document.createElement('div');
            div.className="bg-gray-100 p-4 rounded-lg text-lg mb-3 flex justify-between shadow-sm cursor-pointer hover:bg-gray-200 transition";
            div.innerHTML=`<span class="truncate w-2/3 font-bold">${d.data().question}</span><button class="text-red-500 hover:text-red-700 p-2" onclick="deleteItem('${col}','${d.id}')">ğŸ—‘ï¸</button>`;
            div.onclick=(e)=>{if(e.target.tagName!=='BUTTON')alert(d.data().response||d.data().answer)};
            list.appendChild(div);
        });
    }
    window.deleteItem = async (c,i) => { if(confirm("ì‚­ì œ?")) { await deleteDoc(doc(currentMode==='tarot'?dbTarot:dbSaju, c, i)); window.openHistory(); } }
    window.checkAdmin = () => { if(prompt("ì•”í˜¸")==="5690") document.getElementById('admin-modal').classList.remove('hidden'); }
    window.previewImage = (i) => { const r=new FileReader(); r.onload=e=>document.getElementById('admin-img-preview').src=e.target.result; r.readAsDataURL(i.files[0]); }
    window.saveAdmin = async () => { if(dbTarot) await setDoc(doc(dbTarot,"settings","config"), {imgUrl:document.getElementById('admin-img-preview').src}, {merge:true}); alert("ì €ì¥"); location.reload(); }
    async function loadConfig(m,h){ try{const d=(await getDoc(doc(m==='tarot'?dbTarot:dbSaju,"settings","config"))).data(); if(d?.imgUrl) document.getElementById(m==='tarot'?'intro-panda-img':'intro-cat-img').src=d.imgUrl; if(!h && d?.imgUrl) document.getElementById(`${m}-mascot`).src=d.imgUrl; }catch(e){}}

    // CSS Injection
    const s = document.createElement('style');
    s.innerHTML = `.wood{background:#2e7d32}.fire{background:#d32f2f}.earth{background:#fbc02d;color:#3e2723}.metal{background:#757575}.water{background:#212121}`;
    document.head.appendChild(s);
</script>
</body>
</html>
