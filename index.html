<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HG AI Agents: Real Tarot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Do+Hyeon&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --app-bg-tarot: #e8f5e9; --app-bg-saju: #fffdf5; }
        body { background-color: #000; margin: 0; overflow: hidden; font-family: 'Do Hyeon', sans-serif; display: flex; justify-content: center; align-items: center; height: 100dvh; }
        .hidden { display: none !important; }
        
        .app-container { width: 100%; max-width: 600px; height: 100dvh; display: flex; flex-direction: column; position: relative; background: #fff; overflow: hidden; box-shadow: 0 0 50px rgba(0,0,0,0.5); }

        /* ë¡œê·¸ì¸ */
        #login-screen { position: absolute; inset: 0; z-index: 9999; background: url('https://images.unsplash.com/photo-1511497584788-876760111969?q=80&w=1000&auto=format&fit=crop') no-repeat center center; background-size: cover; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #login-screen::before { content: ''; position: absolute; inset: 0; background: rgba(0, 30, 10, 0.6); backdrop-filter: blur(3px); }
        .maple-title { z-index: 10; font-family: 'Black Han Sans', sans-serif; font-size: 3.5rem; color: #fff; text-shadow: 2px 2px 0 #ff6f00; margin-bottom: 20px; animation: float-title 3s infinite; }
        @keyframes float-title { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .login-board { z-index: 10; width: 85%; max-width: 350px; background: #8d6e63; border: 4px solid #3e2723; border-radius: 15px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.6); display: flex; flex-direction: column; gap: 10px; }
        .maple-input { width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 2px solid #a1887f; border-radius: 8px; color: #fff; text-align: center; }
        .maple-btn { width: 100%; padding: 10px; background: #ffca28; border: 2px solid #3e2723; border-radius: 8px; font-weight: bold; color: #3e2723; }

        /* ì„ íƒ í™”ë©´ */
        #selection-screen { position: absolute; inset: 0; background: #000; }
        .split-panel { position: absolute; top: 0; bottom: 0; width: 100%; height: 100%; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: 0.3s; }
        .panel-left { background: linear-gradient(135deg, #66bb6a 0%, #2e7d32 100%); clip-path: polygon(0 0, 60% 0, 40% 100%, 0 100%); left: 0; z-index: 10; }
        .panel-right { background: linear-gradient(135deg, #fff8e1 0%, #ffe0b2 100%); clip-path: polygon(60% 0, 100% 0, 100% 100%, 40% 100%); right: 0; z-index: 10; }
        .char-img { width: 180px; height: 180px; object-fit: contain; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.3)); animation: float 3s infinite ease-in-out; }
        
        /* ê³µí†µ í—¤ë”/ë²„íŠ¼ */
        .theme-tarot .app-container { background: var(--app-bg-tarot); } .theme-saju .app-container { background: var(--app-bg-saju); }
        #main-header { padding: 15px; display: flex; justify-content: space-between; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 50; flex-shrink: 0; }
        .action-btn { border-radius: 25px; padding: 12px; border: none; font-size: 1.1rem; font-family: 'Black Han Sans', sans-serif; cursor: pointer; box-shadow: 0 4px 0 rgba(0,0,0,0.2); transition: 0.1s; }
        .action-btn:active { transform: translateY(4px); box-shadow: none; }

        /* íƒ€ë¡œ ì¹´ë“œ ì˜ì—­ */
        #tarot-card-table { 
            display: flex; flex-wrap: wrap; justify-content: center; align-content: flex-start; 
            gap: 4px; padding: 10px 5px; perspective: 1000px; 
            overflow-y: auto; flex: 1; width: 100%;
        }
        .tarot-card-face { 
            width: 45px; height: 70px; /* ë§ì€ ì¹´ë“œë¥¼ ë‹´ê¸° ìœ„í•´ ì¡°ì • */
            background: radial-gradient(circle at center, #512da8 0%, #311b92 100%); 
            border: 1px solid #d1c4e9; border-radius: 4px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.4); 
            display: flex; justify-content: center; align-items: center; 
            cursor: pointer; position: relative; transition: transform 0.1s;
        }
        .tarot-card-face::after { content: 'ğŸ‹'; font-size: 1.2rem; opacity: 0.7; }
        .card-selected { 
            background: radial-gradient(circle at center, #ffd54f 0%, #ff6f00 100%) !important; 
            border: 2px solid #fff !important; 
            transform: translateY(-10px) scale(1.2) !important; 
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.9) !important; 
            z-index: 50; 
        }
        .card-selected::after { content: 'âœ¨'; }

        /* ì…”í”Œ ì• ë‹ˆë©”ì´ì…˜ */
        .deck-stack { position: relative; width: 100px; height: 150px; }
        .deck-card { position: absolute; inset: 0; background: #2e7d32; border: 3px solid #fff; border-radius: 8px; display: flex; justify-content: center; align-items: center; font-size: 2rem; }
        .deck-card::after { content: 'ğŸ‹'; }
        .shuffling .deck-card:nth-child(1) { animation: shf 0.4s infinite alternate; }
        .shuffling .deck-card:nth-child(2) { animation: shf 0.4s infinite alternate-reverse 0.1s; }
        @keyframes shf { from{transform:translateX(0)} to{transform:translateX(-15px) rotate(-5deg)} }

        /* Markdown */
        .markdown-body h1, .markdown-body h2 { border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 10px; color: #333; }
        .markdown-body strong { color: #d32f2f; }
    </style>
</head>
<body>

<div class="app-container">
    <div id="login-screen">
        <h1 class="maple-title">HG AI Agents</h1>
        <div class="login-board">
            <div class="text-center text-white/80 text-sm font-bold">Real Tarot Engine v2.0</div>
            <input type="password" id="login-api-key" class="maple-input" placeholder="Google Gemini API Key">
            <button onclick="attemptLogin()" class="maple-btn">ì ‘ì†</button>
        </div>
    </div>

    <div id="selection-screen" class="hidden">
        <div class="split-panel panel-left" onclick="selectMode('tarot')">
            <img id="intro-panda-img" src="./panda.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3069/3069172.png'" class="char-img">
            <div class="bg-white/90 px-4 py-1 rounded-full mt-2 font-bold border-2 border-green-800 text-green-800">íƒ€ë¡œ íŒë‹¤</div>
        </div>
        <div class="split-panel panel-right" onclick="selectMode('saju')">
            <img id="intro-cat-img" src="./cat.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/616/616430.png'" class="char-img">
            <div class="bg-white/90 px-4 py-1 rounded-full mt-2 font-bold border-2 border-red-800 text-red-800">ë¬´ì† ëƒ¥ì´</div>
        </div>
    </div>

    <div id="main-app-ui" class="hidden h-full flex flex-col relative">
        <header id="main-header">
            <button onclick="goHome()" class="bg-white/20 px-3 py-1 rounded-full text-sm font-bold">â—€ ì²˜ìŒìœ¼ë¡œ</button>
            <div class="flex gap-2">
                <button onclick="openHistory()" class="bg-white/20 px-3 py-1 rounded-full text-sm">ğŸ“œ</button>
                <button onclick="checkAdmin()" class="text-white opacity-70">âš™ï¸</button>
            </div>
        </header>

        <div id="tarot-app" class="hidden flex-1 flex flex-col overflow-hidden relative">
            <div id="tarot-view-start" class="flex flex-col items-center justify-center text-center h-full p-4">
                <img id="tarot-mascot" src="./panda.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3069/3069172.png'" class="w-24 h-24 rounded-full border-4 border-green-600 mb-4 bg-white object-cover">
                <h2 class="text-2xl font-bold text-green-900 mb-1">ë¦¬ì–¼ íƒ€ë¡œ ìƒë‹´ì†Œ</h2>
                <p class="text-green-700 text-sm mb-6">ì§„ì§œ ë±ì„ ì„ì–´ ìš´ëª…ì„ ì ì¹©ë‹ˆë‹¤.</p>
                <input type="text" id="tarot-input" placeholder="ê³ ë¯¼ì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full p-4 border-2 border-green-400 rounded-xl text-center mb-4 font-bold bg-white shadow-sm" onkeypress="if(event.key==='Enter') startTarotFlow()">
                <button class="action-btn bg-green-600 text-white w-full shadow-lg" onclick="startTarotFlow()">ì¹´ë“œ ì„ê¸° ì‹œì‘</button>
            </div>

            <div id="tarot-shuffle-view" class="hidden h-full flex flex-col items-center justify-center bg-green-50">
                <div class="deck-stack shuffling mb-6">
                    <div class="deck-card"></div><div class="deck-card"></div>
                </div>
                <h3 class="text-xl font-bold text-green-800 animate-pulse">ìš´ëª…ì„ ì„ëŠ” ì¤‘...</h3>
                <p class="text-xs text-green-600 mt-2">ë¬´ì‘ìœ„ ë°°ì—´ ìƒì„± ì¤‘ (Fisher-Yates Shuffle)</p>
            </div>

            <div id="tarot-view-game" class="hidden flex flex-col h-full overflow-hidden">
                <div class="bg-green-100 p-2 text-center shadow-sm z-10 flex-shrink-0 flex justify-between items-center px-4">
                    <div class="text-left">
                        <div id="tarot-deck-name" class="font-bold text-green-900 text-sm">ë± ì´ë¦„</div>
                        <div id="tarot-deck-info" class="text-xs text-green-700">ì´ 00ì¥ ì¤‘ 0ì¥ ì„ íƒ</div>
                    </div>
                    <div id="tarot-selection-count" class="font-bold text-green-800 text-lg">0 / 3</div>
                </div>
                
                <div id="tarot-card-table"></div>

                <div class="p-3 bg-white border-t border-gray-200 z-20 flex-shrink-0 shadow-[0_-5px_15px_rgba(0,0,0,0.1)]">
                    <button id="tarot-next-btn" class="action-btn bg-green-600 text-white w-full hidden shadow-lg" onclick="confirmTarotSelection()">ê²°ê³¼ í™•ì¸</button>
                    <div id="tarot-guide-msg" class="text-center text-gray-400 text-xs font-bold py-3">ì‹ ì¤‘í•˜ê²Œ ì¹´ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
                </div>
            </div>
        </div>

        <div id="saju-app" class="hidden flex-1 flex flex-col p-4 overflow-y-auto">
            <div id="saju-view-start" class="flex flex-col items-center justify-center text-center h-full">
                <img id="saju-mascot" src="./cat.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/616/616430.png'" class="w-24 h-24 rounded-full border-4 border-red-400 mb-4 bg-white object-cover">
                <h2 class="text-xl font-bold text-red-900 mb-4">ì •í†µ ì‚¬ì£¼ ëª…ë¦¬</h2>
                <div class="w-full bg-white p-4 rounded-xl border border-red-200 space-y-3 shadow-sm">
                    <input type="date" id="saju-date" class="w-full p-3 border rounded bg-red-50 font-bold text-center" value="2000-01-01">
                    <div class="flex gap-2">
                        <input type="time" id="saju-time" class="w-full p-3 border rounded bg-red-50 text-center" value="12:00">
                        <select id="saju-gender" class="w-full p-3 border rounded bg-red-50 text-center"><option value="male">ë‚¨</option><option value="female">ì—¬</option></select>
                    </div>
                    <button class="action-btn bg-red-500 text-white w-full mt-2" onclick="processSajuManse()">ë§Œì„¸ë ¥ í™•ì¸</button>
                </div>
            </div>
            <div id="saju-view-icebreak" class="hidden h-full flex flex-col">
                <div class="bg-white p-4 rounded-xl border-2 border-red-800 mb-4 text-center">
                    <div id="saju-pillars" class="flex justify-center gap-2 mb-2"></div>
                    <p id="saju-persona-msg" class="text-sm text-gray-600">ë¶„ì„ ì™„ë£Œ.</p>
                </div>
                <div class="mt-auto">
                    <input type="text" id="saju-input" placeholder="ê¶ê¸ˆí•œ ì ì„ ë¬¼ì–´ë³´ì„¸ìš”" class="w-full p-4 border-2 border-red-800 rounded-xl mb-3 font-bold">
                    <button class="action-btn bg-red-500 text-white w-full" onclick="startSajuConsult()">ìƒë‹´ í•˜ê¸°</button>
                </div>
            </div>
        </div>

        <div id="common-view-loading" class="hidden absolute inset-0 bg-white/95 z-50 flex flex-col items-center justify-center text-center p-6">
            <img id="loading-img" src="" class="w-20 h-20 rounded-full mb-4 animate-bounce border-2 border-gray-300">
            <p id="loading-text" class="text-lg font-bold text-gray-700">AI ë¶„ì„ ì¤‘...</p>
        </div>
        <div id="common-view-result" class="hidden absolute inset-0 bg-white z-40 flex flex-col p-4 overflow-y-auto">
            <div class="text-right mb-2"><button onclick="resetCurrentMode()" class="text-xs text-gray-500 underline">ì²˜ìŒìœ¼ë¡œ</button></div>
            <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 mb-3"><span class="font-bold text-gray-600">Q.</span> <span id="result-question" class="font-bold text-sm">ì§ˆë¬¸</span></div>
            <div class="flex-1 bg-white border border-gray-300 rounded-lg p-4 relative overflow-y-auto shadow-inner">
                <div id="result-content" class="markdown-body text-sm leading-6 text-gray-800"></div>
            </div>
            <button class="action-btn bg-gray-800 text-white w-full mt-3" onclick="resetCurrentMode()">ë‹«ê¸°</button>
        </div>
        <div id="common-view-history" class="hidden absolute inset-0 bg-white z-50 flex flex-col p-4">
            <h3 class="text-center font-bold text-lg mb-4">ìƒë‹´ ê¸°ë¡</h3>
            <div id="history-list" class="flex-1 overflow-y-auto space-y-2 p-1"></div>
            <button class="p-3 bg-gray-200 rounded-lg font-bold mt-2" onclick="document.getElementById('common-view-history').classList.add('hidden')">ë‹«ê¸°</button>
        </div>
    </div>
    
    <div id="admin-modal" class="hidden absolute inset-0 bg-black/80 z-[100] flex items-center justify-center p-4">
        <div class="bg-white p-5 rounded-lg w-full max-w-sm">
            <h3 class="font-bold text-lg mb-2">ì„¤ì •</h3>
            <input type="file" id="admin-file-input" accept="image/*" class="w-full text-xs mb-2" onchange="previewImage(this)">
            <img id="admin-img-preview" class="w-12 h-12 rounded-full border mb-4">
            <button onclick="saveAdmin()" class="action-btn bg-blue-600 text-white w-full text-sm">ì €ì¥</button>
            <button onclick="document.getElementById('admin-modal').classList.add('hidden')" class="w-full mt-2 text-sm text-gray-400">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, doc, setDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const tarotConfig = { apiKey: "AIzaSyDuQDOi5wxabpqdqu-CJfdR-krk5Q08tBA", projectId: "test-9da10", appId: "1:578765851412:web:5d9d30e09f8427d1a49001" };
    const sajuConfig = { apiKey: "AIzaSyB-y3inMOTdj48gwlh0eftUc_YfyNTeJmc", projectId: "sajutest-e4eaa", appId: "1:753725539148:web:f2d67dd6b3adf6514345e9" };
    let dbTarot, dbSaju;
    try { dbTarot = getFirestore(initializeApp(tarotConfig, "tarotApp")); dbSaju = getFirestore(initializeApp(sajuConfig, "sajuApp")); } catch(e){}

    let currentMode = null; 
    let gameState = { stage: 0, deck: [], selections: [], question: "" }; // deck ë°°ì—´ì— ì‹¤ì œ ì¹´ë“œ ì •ë³´ ì €ì¥
    let sajuState = { pillars: [], info: {} };
    let uploadedImageBase64 = null; 
    let userApiKey = null; 

    // --- Data: ì‹¤ì œ íƒ€ë¡œ ë± ë°ì´í„° ---
    const DECK_DATA = {
        waite: {
            name: "ìœ ë‹ˆë²„ì…œ ì›¨ì´íŠ¸", count: 78, pick: 3,
            cards: [
                "0.ê´‘ëŒ€(The Fool)", "1.ë§ˆë²•ì‚¬(The Magician)", "2.ì—¬ì‚¬ì œ(The High Priestess)", "3.ì—¬í™©ì œ(The Empress)", "4.í™©ì œ(The Emperor)", 
                "5.êµí™©(The Hierophant)", "6.ì—°ì¸(The Lovers)", "7.ì „ì°¨(The Chariot)", "8.í˜(Strength)", "9.ì€ë‘”ì(The Hermit)", 
                "10.ìš´ëª…ì˜ ìˆ˜ë ˆë°”í€´(Wheel of Fortune)", "11.ì •ì˜(Justice)", "12.ë§¤ë‹¬ë¦° ì‚¬ëŒ(The Hanged Man)", "13.ì£½ìŒ(Death)", "14.ì ˆì œ(Temperance)", 
                "15.ì•…ë§ˆ(The Devil)", "16.íƒ‘(The Tower)", "17.ë³„(The Star)", "18.ë‹¬(The Moon)", "19.íƒœì–‘(The Sun)", "20.ì‹¬íŒ(Judgement)", "21.ì„¸ê³„(The World)",
                // Wands
                "Ace of Wands", "2 of Wands", "3 of Wands", "4 of Wands", "5 of Wands", "6 of Wands", "7 of Wands", "8 of Wands", "9 of Wands", "10 of Wands", "Page of Wands", "Knight of Wands", "Queen of Wands", "King of Wands",
                // Cups
                "Ace of Cups", "2 of Cups", "3 of Cups", "4 of Cups", "5 of Cups", "6 of Cups", "7 of Cups", "8 of Cups", "9 of Cups", "10 of Cups", "Page of Cups", "Knight of Cups", "Queen of Cups", "King of Cups",
                // Swords
                "Ace of Swords", "2 of Swords", "3 of Swords", "4 of Swords", "5 of Swords", "6 of Swords", "7 of Swords", "8 of Swords", "9 of Swords", "10 of Swords", "Page of Swords", "Knight of Swords", "Queen of Swords", "King of Swords",
                // Pentacles
                "Ace of Pentacles", "2 of Pentacles", "3 of Pentacles", "4 of Pentacles", "5 of Pentacles", "6 of Pentacles", "7 of Pentacles", "8 of Pentacles", "9 of Pentacles", "10 of Pentacles", "Page of Pentacles", "Knight of Pentacles", "Queen of Pentacles", "King of Pentacles"
            ]
        },
        belline: {
            name: "í˜¸ë¡œìŠ¤ì½”í”„ ë²¨ë¦°", count: 53, pick: 3,
            cards: Array.from({length:53}, (_,i)=>`Belline Card No.${i+1}`) // ì‹¤ì œ ì´ë¦„ ëŒ€ì‹  ë²ˆí˜¸ë¡œ ì²˜ë¦¬ (AIê°€ í•´ì„ ê°€ëŠ¥)
        },
        lenormand: {
            name: "ë ˆë…¸ë¨¼ë“œ", count: 36, pick: 3,
            cards: [
                "1.Rider", "2.Clover", "3.Ship", "4.House", "5.Tree", "6.Clouds", "7.Snake", "8.Coffin", "9.Bouquet", "10.Scythe",
                "11.Whip", "12.Birds", "13.Child", "14.Fox", "15.Bear", "16.Stars", "17.Stork", "18.Dog", "19.Tower", "20.Garden",
                "21.Mountain", "22.Crossroad", "23.Mice", "24.Heart", "25.Ring", "26.Book", "27.Letter", "28.Gentleman", "29.Lady", "30.Lily",
                "31.Sun", "32.Moon", "33.Key", "34.Fish", "35.Anchor", "36.Cross"
            ]
        }
    };

    // --- Shuffling Algorithm (Fisher-Yates) ---
    function shuffleArray(array) {
        const arr = [...array]; // ë³µì‚¬ë³¸ ìƒì„±
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    }

    // --- Main Logic ---
    window.attemptLogin = () => {
        userApiKey = document.getElementById('login-api-key').value;
        if(!userApiKey) return alert("API Key í•„ìš”");
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('selection-screen').classList.remove('hidden');
        if(dbTarot) loadConfig('tarot', true); if(dbSaju) loadConfig('saju', true);
    };

    window.selectMode = (mode) => {
        currentMode = mode;
        document.getElementById('selection-screen').classList.add('hidden');
        document.getElementById('main-app-ui').classList.remove('hidden');
        document.body.className = ''; document.body.classList.add(`theme-${mode}`);
        document.getElementById('main-header').style.background = mode==='tarot' ? '#2e7d32':'#c62828';
        
        document.getElementById('tarot-app').classList.add('hidden');
        document.getElementById('saju-app').classList.add('hidden');
        document.getElementById(`${mode}-app`).classList.remove('hidden');
        
        if(mode === 'tarot') {
            document.getElementById('tarot-view-start').classList.remove('hidden');
            document.getElementById('tarot-view-game').classList.add('hidden');
        }
        loadConfig(mode);
    };

    window.goHome = () => {
        document.getElementById('main-app-ui').classList.add('hidden');
        document.getElementById('selection-screen').classList.remove('hidden');
    };

    window.resetCurrentMode = () => {
        document.getElementById('common-view-result').classList.add('hidden');
        if(currentMode==='tarot') {
            document.getElementById('tarot-view-start').classList.remove('hidden');
            document.getElementById('tarot-view-game').classList.add('hidden');
        } else {
            document.getElementById('saju-input').value = "";
        }
    };

    // --- Tarot Game Flow ---
    const TAROT_SEQUENCE = ['waite', 'belline', 'lenormand']; // ì§„í–‰ ìˆœì„œ

    window.startTarotFlow = () => {
        const q = document.getElementById('tarot-input').value;
        if(!q) return alert("ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”");
        gameState.question = q;
        gameState.finalSelections = {}; // { waite: [card1, card2], ... }
        runStage(0);
    };

    function runStage(idx) {
        if(idx >= TAROT_SEQUENCE.length) { showFinalResult(); return; }
        
        gameState.stageIdx = idx;
        const deckKey = TAROT_SEQUENCE[idx];
        const deckInfo = DECK_DATA[deckKey];
        
        // 1. ì…”í”Œ í™”ë©´ í‘œì‹œ
        document.getElementById('tarot-view-start').classList.add('hidden');
        document.getElementById('tarot-view-game').classList.add('hidden');
        document.getElementById('tarot-shuffle-view').classList.remove('hidden');
        
        // 2. ì‹¤ì œ ë± ìƒì„± ë° ì…”í”Œ (Real Logic)
        gameState.currentDeck = shuffleArray(deckInfo.cards); // ì„ì¸ ì¹´ë“œ ë°°ì—´
        gameState.currentPicks = [];
        
        setTimeout(() => {
            document.getElementById('tarot-shuffle-view').classList.add('hidden');
            document.getElementById('tarot-view-game').classList.remove('hidden');
            renderTable(deckInfo);
        }, 1500);
    }

    function renderTable(info) {
        document.getElementById('tarot-deck-name').innerText = info.name;
        document.getElementById('tarot-deck-info').innerText = `ì´ ${info.count}ì¥ ì¤‘ ${info.pick}ì¥ ì„ íƒ`;
        updateCount(0, info.pick);
        document.getElementById('tarot-next-btn').classList.add('hidden');
        document.getElementById('tarot-guide-msg').classList.remove('hidden');

        const table = document.getElementById('tarot-card-table');
        table.innerHTML = "";
        
        // ì„ì¸ ë±ì„ ê¸°ë°˜ìœ¼ë¡œ ì¹´ë“œ ìƒì„±
        gameState.currentDeck.forEach((cardName, i) => {
            const card = document.createElement('div');
            card.className = "tarot-card-face";
            // ì¤‘ìš”: í´ë¦­ ì‹œ ì´ ì¹´ë“œì˜ ì‹¤ì œ ì´ë¦„(cardName)ì„ ì‚¬ìš©í•¨
            card.dataset.realValue = cardName; 
            card.dataset.idx = i;
            
            // ì‹œê°ì  ë‚œìˆ˜ (ê¸°ìš¸ê¸°)
            card.style.transform = `rotate(${Math.random()*4 - 2}deg)`;
            
            card.onclick = () => {
                const list = gameState.currentPicks;
                if(card.classList.contains('card-selected')) {
                    card.classList.remove('card-selected');
                    const idx = list.indexOf(cardName);
                    if(idx > -1) list.splice(idx, 1);
                } else {
                    if(list.length >= info.pick) return alert(`ì´ ë±ì—ì„œëŠ” ${info.pick}ì¥ë§Œ ë½‘ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                    card.classList.add('card-selected');
                    list.push(cardName);
                }
                
                updateCount(list.length, info.pick);
                if(list.length === info.pick) {
                    document.getElementById('tarot-next-btn').classList.remove('hidden');
                    document.getElementById('tarot-guide-msg').classList.add('hidden');
                } else {
                    document.getElementById('tarot-next-btn').classList.add('hidden');
                    document.getElementById('tarot-guide-msg').classList.remove('hidden');
                }
            };
            table.appendChild(card);
        });
    }

    function updateCount(c, m) { document.getElementById('tarot-selection-count').innerText = `${c} / ${m}`; }

    window.confirmTarotSelection = () => {
        const currentKey = TAROT_SEQUENCE[gameState.stageIdx];
        gameState.finalSelections[currentKey] = [...gameState.currentPicks]; // ì„ íƒ ì €ì¥
        runStage(gameState.stageIdx + 1); // ë‹¤ìŒ ë±ìœ¼ë¡œ
    };

    async function showFinalResult() {
        document.getElementById('common-view-loading').classList.remove('hidden');
        document.getElementById('loading-text').innerText = "íŒë‹¤ê°€ ì„ íƒëœ ì¹´ë“œë¥¼ ì½ê³  ìˆìŠµë‹ˆë‹¤...";
        document.getElementById('loading-img').src = document.getElementById('tarot-mascot').src;

        // í”„ë¡¬í”„íŠ¸ ìƒì„± (ì‹¤ì œ ë½‘ì€ ì¹´ë“œ ì •ë³´ ì „ë‹¬)
        const s = gameState.finalSelections;
        const prompt = `
        [íƒ€ë¡œ ì ìˆ ]
        ì§ˆë¬¸: "${gameState.question}"
        
        ì‚¬ìš©ìê°€ ì‹¤ì œë¡œ ë½‘ì€ ì¹´ë“œ ëª©ë¡ (ì ˆëŒ€ ë¬´ì‘ìœ„ ìƒì„±ì´ ì•„ë‹˜, ì´ ì¹´ë“œë¥¼ í•´ì„í•´ì•¼ í•¨):
        1. ìœ ë‹ˆë²„ì…œ ì›¨ì´íŠ¸ (ìƒí™©): ${s.waite.join(', ')}
        2. í˜¸ë¡œìŠ¤ì½”í”„ ë²¨ë¦° (ì‹¬ë¦¬): ${s.belline.join(', ')}
        3. ë ˆë…¸ë¨¼ë“œ (ë¯¸ë˜): ${s.lenormand.join(', ')}
        
        ìš”ì²­:
        ìœ„ ì¹´ë“œë“¤ì˜ ìƒì§•ê³¼ ì˜ë¯¸ë¥¼ ì •í™•íˆ ì¡°í•©í•˜ì—¬ ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€ì„ í•´ì£¼ì„¸ìš”.
        ë§íˆ¬: ì¹œì ˆí•˜ê³  ì‹ ë¹„ë¡œìš´ íŒë‹¤ ë§íˆ¬ ("~ë‹¤ íŒë‹¤").
        í˜•ì‹: Markdown.
        1. **ğŸ‹ ë‹¹ì‹ ì´ ë½‘ì€ ëŒ€ë‚˜ë¬´ ì (ì¹´ë“œ)**: (ì¹´ë“œ ì´ë¦„ë“¤ ë‚˜ì—´)
        2. **ğŸ¼ íŒë‹¤ì˜ ê¹Šì€ í•´ì„**: (ê° ë±ì˜ ì˜ë¯¸ë¥¼ ì—°ê²°í•˜ì—¬ í•´ì„)
        3. **ğŸ ëŒ€ë‚˜ë¬´ ìˆ²ì˜ ì¡°ì–¸**: (êµ¬ì²´ì ì¸ í–‰ë™ ì§€ì¹¨)
        `;

        try {
            const text = await callGemini(prompt);
            document.getElementById('common-view-loading').classList.add('hidden');
            document.getElementById('common-view-result').classList.remove('hidden');
            document.getElementById('result-question').innerText = gameState.question;
            document.getElementById('result-content').innerHTML = marked.parse(text);
            
            if(dbTarot) addDoc(collection(dbTarot, "tarot_readings"), { 
                question: gameState.question, 
                cards: gameState.finalSelections,
                response: text, 
                timestamp: new Date() 
            });
        } catch(e) { alert(e.message); }
    }

    // --- Saju Logic ---
    window.processSajuManse = async () => {
        sajuState.info = { date: document.getElementById('saju-date').value, time: document.getElementById('saju-time').value, gender: document.getElementById('saju-gender').value };
        document.getElementById('common-view-loading').classList.remove('hidden');
        try {
            const res = await callGemini(`ì‚¬ì£¼ë§Œì„¸ë ¥JSON. ì •ë³´:${JSON.stringify(sajuState.info)}. ì¶œë ¥:{"pillars":["ê°‘ì","ì„ì¶•","ë³‘ì¸","ì •ë¬˜"],"colors":["wood","earth","fire","wood"]}`, true);
            const data = JSON.parse(res);
            sajuState.pillars = data.pillars;
            const el = document.getElementById('saju-pillars'); el.innerHTML="";
            data.pillars.forEach((p,i)=> el.innerHTML+=`<div class="w-10 h-10 rounded-full flex items-center justify-center text-white text-sm font-bold ${data.colors[i]}">${p}</div>`);
            document.getElementById('common-view-loading').classList.add('hidden');
            document.getElementById('saju-view-icebreak').classList.remove('hidden');
        } catch(e){ document.getElementById('common-view-loading').classList.add('hidden'); }
    }

    window.startSajuConsult = async () => {
        const q = document.getElementById('saju-input').value;
        if(!q) return alert("ì…ë ¥í•˜ì„¸ìš”");
        document.getElementById('common-view-loading').classList.remove('hidden');
        const prompt = `ì‚¬ì£¼:${sajuState.pillars.join(',')}. ì§ˆë¬¸:${q}. ê³ ì–‘ì´ë§íˆ¬. Markdowní•´ì„.`;
        try {
            const text = await callGemini(prompt);
            document.getElementById('common-view-loading').classList.add('hidden');
            document.getElementById('common-view-result').classList.remove('hidden');
            document.getElementById('result-question').innerText = q;
            document.getElementById('result-content').innerHTML = marked.parse(text);
            if(dbSaju) addDoc(collection(dbSaju, "saju_history"), { question: q, answer: text, date: new Date().toISOString() });
        } catch(e){}
    }

    // --- API & Utils ---
    async function callGemini(text, isJson=false) {
        if(!userApiKey) throw new Error("API Key ì—†ìŒ");
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${userApiKey}`;
        const body = { contents: [{ parts: [{ text }] }], generationConfig: isJson?{responseMimeType:"application/json"}:{} };
        const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
        const json = await res.json();
        return json.candidates[0].content.parts[0].text;
    }

    // History & Admin functions (Simplified for length)
    window.openHistory = async () => {
        const list = document.getElementById('history-list');
        document.getElementById('common-view-history').classList.remove('hidden');
        list.innerHTML = "ë¡œë”©...";
        if(!dbTarot) return list.innerHTML = "DB ì—†ìŒ";
        const db = currentMode==='tarot'?dbTarot:dbSaju;
        const col = currentMode==='tarot'?'tarot_readings':'saju_history';
        const snap = await getDocs(query(collection(db, col), orderBy(currentMode==='tarot'?'timestamp':'date', 'desc'), limit(10)));
        list.innerHTML="";
        snap.forEach(d=>{
            const div=document.createElement('div');
            div.className="bg-gray-100 p-2 rounded text-sm mb-2 flex justify-between";
            div.innerHTML=`<span class="truncate w-2/3">${d.data().question}</span><button onclick="deleteItem('${col}','${d.id}')">ğŸ—‘ï¸</button>`;
            div.onclick=(e)=>{if(e.target.tagName!=='BUTTON')alert(d.data().response||d.data().answer)};
            list.appendChild(div);
        });
    }
    window.deleteItem = async (c,i) => { if(confirm("ì‚­ì œ?")) { await deleteDoc(doc(currentMode==='tarot'?dbTarot:dbSaju, c, i)); window.openHistory(); } }
    window.checkAdmin = () => { if(prompt("ì•”í˜¸")==="5690") document.getElementById('admin-modal').classList.remove('hidden'); }
    window.previewImage = (i) => { const r=new FileReader(); r.onload=e=>document.getElementById('admin-img-preview').src=e.target.result; r.readAsDataURL(i.files[0]); }
    window.saveAdmin = async () => { if(dbTarot) await setDoc(doc(dbTarot,"settings","config"), {imgUrl:document.getElementById('admin-img-preview').src}, {merge:true}); alert("ì €ì¥"); location.reload(); }
    async function loadConfig(m,h){ try{const d=(await getDoc(doc(m==='tarot'?dbTarot:dbSaju,"settings","config"))).data(); if(d?.imgUrl) document.getElementById(m==='tarot'?'intro-panda-img':'intro-cat-img').src=d.imgUrl; if(!h && d?.imgUrl) document.getElementById(`${m}-mascot`).src=d.imgUrl; }catch(e){}}

    // CSS Injection
    const s = document.createElement('style');
    s.innerHTML = `.wood{background:#2e7d32}.fire{background:#d32f2f}.earth{background:#fbc02d;color:#3e2723}.metal{background:#757575}.water{background:#212121}`;
    document.head.appendChild(s);
</script>
</body>
</html>
