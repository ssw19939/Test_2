<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HG AI Agents</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Do+Hyeon&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --app-bg-tarot: #e8f5e9; --app-bg-saju: #fffdf5; }
        body { background-color: #f3f4f6; margin: 0; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100dvh; }
        .hidden { display: none !important; }
        
        .app-container { width: 100%; max-width: 1024px; height: 100dvh; display: flex; flex-direction: column; position: relative; background: #fff; overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.05); }

        /* --- 1. ë¡œê·¸ì¸ í™”ë©´ (ì™„ë²½í•œ ì—…ë¬´ìš© ìœ„ì¥) --- */
        #login-screen { position: absolute; inset: 0; z-index: 9999; background: #fff; display: flex; flex-direction: row; font-family: 'Noto Sans KR', sans-serif; }
        
        /* ì‚¬ì´ë“œë°” */
        .sidebar { width: 60px; border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; align-items: center; padding-top: 20px; gap: 20px; background: #fff; }
        .sidebar-icon { width: 40px; height: 40px; border-radius: 8px; display: flex; justify-content: center; align-items: center; cursor: pointer; color: #4b5563; }
        .sidebar-icon.active { background: #eff6ff; color: #2563eb; }
        .sidebar-bottom { margin-top: auto; padding-bottom: 20px; }

        /* ë©”ì¸ ì˜ì—­ */
        .login-main { flex: 1; display: flex; flex-direction: column; position: relative; }
        .top-nav { height: 60px; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; padding: 0 20px; }
        
        .dashboard-content { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding-bottom: 100px; overflow-y: auto; }
        
        .logo-area { text-align: center; margin-bottom: 40px; }
        .logo-img { width: 64px; height: 64px; margin-bottom: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .main-title { font-size: 1.8rem; font-weight: 700; color: #111827; margin-bottom: 5px; }
        .sub-desc { color: #6b7280; font-size: 0.95rem; }

        /* ì•„ì´ì½˜ ê·¸ë¦¬ë“œ */
        .icon-grid { display: flex; gap: 20px; margin-bottom: 40px; }
        .icon-box { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; opacity: 0.8; transition: 0.2s; }
        .icon-box:hover { opacity: 1; transform: translateY(-2px); }
        .icon-circle { width: 56px; height: 56px; border-radius: 16px; border: 1px solid #e5e7eb; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; color: #4b5563; background: #fff; }
        .icon-box.active .icon-circle { border-color: #2563eb; background: #eff6ff; color: #2563eb; box-shadow: 0 0 0 2px #dbeafe; }
        .icon-text { font-size: 0.8rem; font-weight: 600; color: #4b5563; }
        .icon-box.active .icon-text { color: #2563eb; }

        /* ì¹´ë“œ ê·¸ë¦¬ë“œ */
        .card-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; width: 100%; max-width: 800px; padding: 0 20px; }
        .feature-card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 25px; display: flex; flex-direction: column; align-items: center; text-align: center; gap: 10px; cursor: pointer; transition: 0.2s; background: #fff; }
        .feature-card:hover { border-color: #9ca3af; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .card-icon { font-size: 2rem; margin-bottom: 5px; }
        .card-title { font-weight: 700; color: #1f2937; font-size: 1rem; }
        .card-desc { font-size: 0.85rem; color: #6b7280; line-height: 1.5; word-break: keep-all; }
        .feature-card.full-width { grid-column: span 2; flex-direction: row; text-align: left; align-items: center; gap: 20px; }

        /* í•˜ë‹¨ ì…ë ¥ì°½ (API í‚¤ ì…ë ¥) */
        .bottom-input-area { position: absolute; bottom: 0; left: 0; width: 100%; padding: 20px; background: #fff; border-top: 1px solid #e5e7eb; display: flex; justify-content: center; }
        .input-wrapper { width: 100%; max-width: 800px; border: 1px solid #d1d5db; border-radius: 12px; padding: 12px 16px; display: flex; flex-direction: column; gap: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .chat-input { border: none; outline: none; width: 100%; font-size: 0.95rem; color: #374151; resize: none; background: transparent; }
        .input-footer { display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: #6b7280; margin-top: 4px; }
        .badge { background: #f3f4f6; padding: 2px 8px; rounded: 4px; font-weight: 500; display: flex; align-items: center; gap: 4px; }

        /* --- 2. ì„ íƒ í™”ë©´ (ê²Œì„ ìŠ¤íƒ€ì¼ ì• ë‹ˆë©”ì´ì…˜) --- */
        #selection-screen { position: absolute; inset: 0; background: #1a1a1a; overflow: hidden; }
        
        .split-panel { 
            position: absolute; top: 0; bottom: 0; width: 100%; height: 100%; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
            cursor: pointer; overflow: hidden;
        }

        /* ì™¼ìª½ (íƒ€ë¡œ) */
        .panel-left { 
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%); 
            clip-path: polygon(0 0, 55% 0, 45% 100%, 0 100%); 
            z-index: 10; 
        }
        
        /* ì˜¤ë¥¸ìª½ (ì‚¬ì£¼) */
        .panel-right { 
            background: linear-gradient(135deg, #fff8e1 0%, #ffcc80 100%); 
            clip-path: polygon(55% 0, 100% 0, 100% 100%, 45% 100%); 
            z-index: 10; 
        }

        /* â˜… í•µì‹¬ ì• ë‹ˆë©”ì´ì…˜: ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ì˜ì—­ í™•ì¥ â˜… */
        .panel-left:hover { clip-path: polygon(0 0, 85% 0, 65% 100%, 0 100%); z-index: 20; filter: brightness(1.1); }
        .panel-right:hover { clip-path: polygon(35% 0, 100% 0, 100% 100%, 15% 100%); z-index: 20; filter: brightness(1.05); }

        .char-img { 
            width: 260px; height: 260px; object-fit: contain; 
            filter: drop-shadow(0 15px 30px rgba(0,0,0,0.5)); 
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); /* í…ì…˜ê° ìˆëŠ” ì¤Œ */
        }
        
        /* ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ìºë¦­í„° íŠ€ì–´ë‚˜ì˜´ */
        .panel-left:hover .char-img { transform: scale(1.3) rotate(-5deg); }
        .panel-right:hover .char-img { transform: scale(1.3) rotate(5deg); }

        .title-badge { 
            margin-top: 20px; padding: 10px 25px; border-radius: 50px; 
            font-family: 'Black Han Sans', sans-serif; font-size: 2.5rem; 
            background: #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.3); 
            transition: 0.3s; color: #333; z-index: 30;
        }
        .panel-left .title-badge { color: #1b5e20; border: 4px solid #1b5e20; }
        .panel-right .title-badge { color: #e65100; border: 4px solid #e65100; }

        /* --- 3. ë©”ì¸ ì•± ê³µí†µ (ì¬ë¯¸ ëª¨ë“œ) --- */
        .theme-tarot .app-container { background: var(--app-bg-tarot); } .theme-saju .app-container { background: var(--app-bg-saju); }
        #main-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.1); backdrop-filter: blur(5px); z-index: 50; flex-shrink: 0; }
        .header-title { font-family: 'Black Han Sans', sans-serif; font-size: 1.4rem; color: #fff; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .action-btn { width: 100%; padding: 16px; border-radius: 16px; font-family: 'Black Han Sans', sans-serif; font-size: 1.3rem; border: none; cursor: pointer; box-shadow: 0 4px 0 rgba(0,0,0,0.2); transition: 0.1s; margin-top: 10px; }
        .action-btn:active { transform: translateY(4px); box-shadow: none; }
        .btn-green { background: #2e7d32; color: white; }
        .btn-red { background: #d32f2f; color: white; }

        /* íƒ€ë¡œ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        #tarot-card-table { display: flex; flex-wrap: wrap; justify-content: center; align-content: flex-start; gap: 8px; padding: 20px; overflow-y: auto; flex: 1; }
        .tarot-card-face { width: 55px; height: 90px; background: radial-gradient(circle, #4a148c 0%, #311b92 100%); border: 2px solid #b39ddb; border-radius: 8px; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .tarot-card-face:hover { transform: translateY(-10px) scale(1.1); z-index: 10; }
        .card-selected { border: 3px solid #ffd700 !important; background: #ff6f00 !important; transform: translateY(-15px) scale(1.2) !important; box-shadow: 0 0 20px #ffd700 !important; z-index: 20; }
        .card-selected::after { content: 'âœ¨'; font-size: 1.5rem; }

        /* Markdown */
        .markdown-body h1 { border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 12px; font-size: 1.4rem; font-weight: bold; }
        .markdown-body strong { color: #c62828; }
    </style>
</head>
<body>

<div class="app-container">
    
    <div id="login-screen">
        <div class="sidebar">
            <div class="sidebar-icon active"><i class="fas fa-home"></i></div>
            <div class="sidebar-icon"><i class="fas fa-th-large"></i></div>
            <div class="sidebar-icon"><i class="fas fa-folder"></i></div>
            <div class="sidebar-bottom">
                <div class="sidebar-icon"><i class="fas fa-cog"></i></div>
            </div>
        </div>
        
        <div class="login-main">
            <div class="top-nav">
                <i class="fas fa-bars text-gray-500 text-lg"></i>
            </div>
            
            <div class="dashboard-content">
                <div class="logo-area">
                    <img src="https://cdn-icons-png.flaticon.com/512/4712/4712035.png" class="logo-img mx-auto">
                    <h1 id="login-title-text" class="main-title">HG AI Agents</h1>
                    <p id="login-desc-text" class="sub-desc">í•œë¯¸ê¸€ë¡œë²Œì˜ ë‹¤ì–‘í•œ AI íˆ´ì„ í•œê³³ì—ì„œ ì´ìš©í•˜ëŠ” í†µí•© í”Œë«í¼</p>
                </div>

                <div class="icon-grid">
                    <div class="icon-box active">
                        <div class="icon-circle"><i class="fas fa-comment-dots"></i></div>
                        <span class="icon-text">AI ì±„íŒ…</span>
                    </div>
                    <div class="icon-box">
                        <div class="icon-circle"><i class="fas fa-stars"></i></div>
                        <span class="icon-text">Agentic AI</span>
                    </div>
                    <div class="icon-box">
                        <div class="icon-circle"><i class="fas fa-rocket"></i></div>
                        <span class="icon-text">AI ì—…ë¬´ì§€ì›</span>
                    </div>
                    <div class="icon-box">
                        <div class="icon-circle"><i class="fas fa-globe"></i></div>
                        <span class="icon-text">AI ë²ˆì—­</span>
                    </div>
                    <div class="icon-box">
                        <div class="icon-circle"><i class="fas fa-image"></i></div>
                        <span class="icon-text">AI ì´ë¯¸ì§€</span>
                    </div>
                </div>

                <div class="card-grid">
                    <div class="feature-card">
                        <div class="card-icon">ğŸ“š</div>
                        <div class="card-title">KM Search</div>
                        <div class="card-desc">í•œë¯¸ê¸€ë¡œë²Œ KM ìë£Œë¥¼ ì‹¬ì¸µ ê²€ìƒ‰í•˜ì—¬ ê¹Šì´ ìˆëŠ” ë‹µë³€ì„ ì œê³µí•©ë‹ˆë‹¤.</div>
                    </div>
                    <div class="feature-card">
                        <div class="card-icon">ğŸ”</div>
                        <div class="card-title">Deep Research</div>
                        <div class="card-desc">ì›¹ë¬¸ì„œë¥¼ ì‹¬ì¸µ ê²€ìƒ‰í•˜ì—¬ ê¹Šì´ ìˆëŠ” ë‹µë³€ì„ ì œê³µí•©ë‹ˆë‹¤.</div>
                    </div>
                    <div class="feature-card full-width">
                        <div class="card-icon">ğŸ’¬</div>
                        <div>
                            <div class="card-title">AI ì¼ë°˜ ì±—ë´‡</div>
                            <div class="card-desc">ì´ì „ ë²„ì „ HG AI ì±—ë´‡ì…ë‹ˆë‹¤.</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bottom-input-area">
                <div class="input-wrapper">
                    <input type="password" id="login-api-key" class="chat-input" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”... (AIì™€ ëŒ€í™”í•˜ë ¤ë©´ Enter)" onkeypress="if(event.key==='Enter') attemptLogin()">
                    <div class="input-footer">
                        <div class="flex gap-2">
                            <span class="badge"><i class="fas fa-paperclip"></i> AI ëª¨ë¸</span>
                            <span class="badge">Gemini 3 Pro (Preview) â–¼</span>
                            <span class="badge">Thinking ë ˆë²¨ ë†’ìŒ â–¼</span>
                        </div>
                        <i class="fas fa-microphone text-lg cursor-pointer hover:text-blue-500" onclick="attemptLogin()"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="selection-screen" class="hidden">
        <div class="split-panel panel-left" onclick="selectMode('tarot')">
            <img id="img-panda" src="./panda.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3069/3069172.png'" class="char-img">
            <div id="text-panda" class="title-badge">íƒ€ë¡œ íŒë‹¤</div>
        </div>
        <div class="split-panel panel-right" onclick="selectMode('saju')">
            <img id="img-cat" src="./cat.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/616/616430.png'" class="char-img">
            <div id="text-cat" class="title-badge">ë¬´ì† ëƒ¥ì´</div>
        </div>
    </div>

    <div id="main-app-ui" class="hidden h-full flex flex-col relative font-fun">
        <header id="main-header">
            <button onclick="goHome()" class="text-white text-lg"><i class="fas fa-chevron-left"></i> ì²˜ìŒìœ¼ë¡œ</button>
            <h1 id="header-title" class="header-title">ìƒë‹´ì†Œ</h1>
            <div class="flex gap-3 text-white text-lg">
                <button onclick="openHistory()"><i class="fas fa-history"></i></button>
                <button onclick="checkAdmin()"><i class="fas fa-cog"></i></button>
            </div>
        </header>

        <div id="tarot-app" class="hidden flex-1 flex flex-col overflow-hidden relative">
            <div id="tarot-view-start" class="flex flex-col items-center justify-center text-center h-full p-6">
                <img id="mascot-tarot" src="./panda.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3069/3069172.png'" class="w-32 h-32 rounded-full border-4 border-green-700 bg-white object-cover mb-4">
                <h2 class="text-3xl font-impact text-green-900 mb-2">ë¦¬ì–¼ íƒ€ë¡œ</h2>
                <input type="text" id="tarot-input" placeholder="ê³ ë¯¼ì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full p-4 border-2 border-green-600 rounded-xl text-center mb-4 text-lg" onkeypress="if(event.key==='Enter') startTarotFlow()">
                <button class="action-btn btn-green" onclick="startTarotFlow()">ì¹´ë“œ ì„ê¸°</button>
            </div>

            <div id="tarot-shuffle-view" class="hidden h-full flex flex-col items-center justify-center bg-green-50">
                <h3 class="text-2xl font-bold text-green-800 animate-pulse">ìš´ëª…ì„ ì„ëŠ” ì¤‘...</h3>
            </div>

            <div id="tarot-view-game" class="hidden flex flex-col h-full overflow-hidden">
                <div class="bg-green-100 p-4 text-center shadow-sm z-10 flex justify-between items-center">
                    <div class="text-left">
                        <div id="tarot-deck-name" class="font-bold text-green-900 text-lg">ë± ì´ë¦„</div>
                        <div id="tarot-deck-info" class="text-sm text-green-700">0ì¥ ì„ íƒ</div>
                    </div>
                    <div id="tarot-selection-count" class="font-bold text-green-800 text-2xl">0 / 3</div>
                </div>
                <div id="tarot-card-table"></div>
                <div class="p-4 bg-white border-t z-20">
                    <button id="tarot-next-btn" class="action-btn btn-green hidden" onclick="confirmTarotSelection()">ê²°ê³¼ í™•ì¸</button>
                </div>
            </div>
        </div>

        <div id="saju-app" class="hidden flex-1 flex flex-col p-6 overflow-y-auto">
            <div id="saju-view-start" class="flex flex-col items-center justify-center text-center h-full">
                <img id="mascot-saju" src="./cat.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/616/616430.png'" class="w-32 h-32 rounded-full border-4 border-red-500 bg-white object-cover mb-4">
                <h2 class="text-3xl font-impact text-red-900 mb-2">ì •í†µ ì‚¬ì£¼</h2>
                <div class="w-full bg-white p-6 rounded-xl border border-red-200 space-y-4 shadow-sm">
                    <input type="date" id="saju-date" class="w-full p-3 border rounded text-center text-lg" value="2000-01-01">
                    <div class="flex gap-2">
                        <input type="time" id="saju-time" class="w-full p-3 border rounded text-center" value="12:00">
                        <select id="saju-gender" class="w-full p-3 border rounded text-center"><option value="male">ë‚¨ì„±</option><option value="female">ì—¬ì„±</option></select>
                    </div>
                    <button class="action-btn btn-red" onclick="processSajuManse()">ë§Œì„¸ë ¥ ë³´ê¸°</button>
                </div>
            </div>
            <div id="saju-view-icebreak" class="hidden h-full flex flex-col">
                <div class="bg-white p-4 rounded-xl border-2 border-red-800 mb-4 text-center">
                    <div id="saju-pillars" class="flex justify-center gap-2 mb-2"></div>
                    <p id="saju-persona-msg">ë¶„ì„ ì™„ë£Œ</p>
                </div>
                <div class="mt-auto">
                    <input type="text" id="saju-input" placeholder="ì§ˆë¬¸ ì…ë ¥" class="w-full p-4 border-2 border-red-800 rounded-xl mb-4 text-lg">
                    <button class="action-btn btn-red" onclick="startSajuConsult()">ìƒë‹´ í•˜ê¸°</button>
                </div>
            </div>
        </div>

        <div id="common-view-loading" class="hidden absolute inset-0 bg-white/95 z-50 flex flex-col items-center justify-center text-center">
            <p id="loading-text" class="text-2xl font-bold text-gray-700 animate-pulse">ë¶„ì„ ì¤‘...</p>
        </div>
        <div id="common-view-result" class="hidden absolute inset-0 bg-white z-40 flex flex-col p-6 overflow-y-auto">
            <div class="text-right mb-2"><button onclick="resetCurrentMode()" class="text-gray-500 underline">ì²˜ìŒìœ¼ë¡œ</button></div>
            <div class="bg-gray-100 p-4 rounded-xl mb-4"><span class="font-bold">Q.</span> <span id="result-question"></span></div>
            <div class="flex-1 bg-white border rounded-xl p-4 overflow-y-auto">
                <div id="result-content" class="markdown-body leading-relaxed"></div>
            </div>
            <button class="action-btn bg-gray-800 text-white mt-4" onclick="resetCurrentMode()">ë‹«ê¸°</button>
        </div>
        
        <div id="common-view-history" class="hidden absolute inset-0 bg-white z-50 flex flex-col p-6">
            <h3 class="text-center font-bold text-2xl mb-4">ê¸°ë¡</h3>
            <div id="history-list" class="flex-1 overflow-y-auto space-y-3"></div>
            <button class="action-btn bg-gray-300 text-gray-800 mt-4" onclick="document.getElementById('common-view-history').classList.add('hidden')">ë‹«ê¸°</button>
        </div>
    </div>
    
    <div id="admin-modal" class="hidden absolute inset-0 bg-black/80 z-[100] flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-2xl w-full max-w-md shadow-2xl max-h-[90vh] overflow-y-auto font-corp">
            <h3 class="font-bold text-xl mb-4 border-b pb-2">âš™ï¸ ê´€ë¦¬ì ì„¤ì •</h3>
            
            <div class="space-y-4">
                <div class="bg-gray-50 p-3 rounded border">
                    <label class="block text-xs font-bold text-blue-600 mb-1">ë¡œê·¸ì¸ í™”ë©´ (ìœ„ì¥ìš©)</label>
                    <div class="mb-2">
                        <span class="text-xs text-gray-500">ë©”ì¸ íƒ€ì´í‹€</span>
                        <input type="text" id="admin-login-title" class="w-full border p-2 rounded text-sm" placeholder="ì˜ˆ: HG AI Agents">
                    </div>
                    <div>
                        <span class="text-xs text-gray-500">ì„œë¸Œ ì„¤ëª…</span>
                        <input type="text" id="admin-login-desc" class="w-full border p-2 rounded text-sm" placeholder="ì˜ˆ: í•œë¯¸ê¸€ë¡œë²Œì˜...">
                    </div>
                </div>

                <div class="bg-gray-50 p-3 rounded border">
                    <label class="block text-xs font-bold text-green-600 mb-1">ìºë¦­í„° ì„¤ì • (íƒ€ë¡œ)</label>
                    <div class="mb-2">
                        <span class="text-xs text-gray-500">ì´ë¦„</span>
                        <input type="text" id="admin-tarot-name" class="w-full border p-2 rounded text-sm" placeholder="ì˜ˆ: íƒ€ë¡œ íŒë‹¤">
                    </div>
                    <div class="flex items-center gap-2">
                        <img id="preview-panda" class="w-10 h-10 rounded border">
                        <input type="file" id="file-panda" accept="image/*" class="text-xs" onchange="previewFile(this, 'preview-panda')">
                    </div>
                </div>

                <div class="bg-gray-50 p-3 rounded border">
                    <label class="block text-xs font-bold text-red-600 mb-1">ìºë¦­í„° ì„¤ì • (ì‚¬ì£¼)</label>
                    <div class="mb-2">
                        <span class="text-xs text-gray-500">ì´ë¦„</span>
                        <input type="text" id="admin-saju-name" class="w-full border p-2 rounded text-sm" placeholder="ì˜ˆ: ë¬´ì† ëƒ¥ì´">
                    </div>
                    <div class="flex items-center gap-2">
                        <img id="preview-cat" class="w-10 h-10 rounded border">
                        <input type="file" id="file-cat" accept="image/*" class="text-xs" onchange="previewFile(this, 'preview-cat')">
                    </div>
                </div>
            </div>

            <button onclick="saveAdmin()" class="w-full bg-blue-600 text-white p-3 rounded-lg font-bold mt-6">ì €ì¥ ë° ì ìš©</button>
            <button onclick="document.getElementById('admin-modal').classList.add('hidden')" class="w-full p-3 text-gray-500 mt-2">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, doc, setDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const tarotConfig = { apiKey: "AIzaSyDuQDOi5wxabpqdqu-CJfdR-krk5Q08tBA", projectId: "test-9da10", appId: "1:578765851412:web:5d9d30e09f8427d1a49001" };
    const sajuConfig = { apiKey: "AIzaSyB-y3inMOTdj48gwlh0eftUc_YfyNTeJmc", projectId: "sajutest-e4eaa", appId: "1:753725539148:web:f2d67dd6b3adf6514345e9" };
    
    let dbTarot, dbSaju;
    try { dbTarot = getFirestore(initializeApp(tarotConfig, "tarotApp")); dbSaju = getFirestore(initializeApp(sajuConfig, "sajuApp")); } catch(e){}

    let userApiKey = null;
    let currentMode = null;
    let gameState = { stage: 0, deck: [], selections: [], question: "", finalSelections: {} };
    let sajuState = { pillars: [], info: {} };
    
    // ì´ë¯¸ì§€ ë°ì´í„° ì €ì¥ìš©
    let imgPandaBase64 = null;
    let imgCatBase64 = null;

    // --- Init ---
    window.onload = () => { loadConfig(); };

    // --- Logic ---
    window.attemptLogin = () => {
        const key = document.getElementById('login-api-key').value;
        if(!key) return alert("API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        userApiKey = key;
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('selection-screen').classList.remove('hidden');
    };

    window.selectMode = (mode) => {
        currentMode = mode;
        document.getElementById('selection-screen').classList.add('hidden');
        document.getElementById('main-app-ui').classList.remove('hidden');
        document.body.className = ''; document.body.classList.add(`theme-${mode}`);
        document.getElementById('header-title').innerText = mode==='tarot' ? document.getElementById('text-panda').innerText : document.getElementById('text-cat').innerText;
        
        document.getElementById('tarot-app').classList.add('hidden');
        document.getElementById('saju-app').classList.add('hidden');
        document.getElementById(`${mode}-app`).classList.remove('hidden');
        
        if(mode === 'tarot') {
            document.getElementById('tarot-view-start').classList.remove('hidden');
            document.getElementById('tarot-view-game').classList.add('hidden');
        }
    };

    window.goHome = () => {
        document.getElementById('main-app-ui').classList.add('hidden');
        document.getElementById('selection-screen').classList.remove('hidden');
    };

    window.resetCurrentMode = () => {
        document.getElementById('common-view-result').classList.add('hidden');
        if(currentMode==='tarot') {
            document.getElementById('tarot-view-start').classList.remove('hidden');
            document.getElementById('tarot-view-game').classList.add('hidden');
        } else {
            document.getElementById('saju-input').value = "";
        }
    };

    // --- Admin Logic (í…ìŠ¤íŠ¸/ì´ë¯¸ì§€ ë³€ê²½) ---
    window.checkAdmin = () => {
        if(prompt("ê´€ë¦¬ì ì•”í˜¸") === "5690") {
            const modal = document.getElementById('admin-modal');
            modal.classList.remove('hidden');
            
            // í˜„ì¬ ê°’ ë¶ˆëŸ¬ì˜¤ê¸°
            document.getElementById('admin-login-title').value = document.getElementById('login-title-text').innerText;
            document.getElementById('admin-login-desc').value = document.getElementById('login-desc-text').innerText;
            document.getElementById('admin-tarot-name').value = document.getElementById('text-panda').innerText;
            document.getElementById('admin-saju-name').value = document.getElementById('text-cat').innerText;
            
            document.getElementById('preview-panda').src = document.getElementById('img-panda').src;
            document.getElementById('preview-cat').src = document.getElementById('img-cat').src;
        }
    };

    window.previewFile = (input, imgId) => {
        if(input.files && input.files[0]) {
            const r = new FileReader();
            r.onload = (e) => {
                document.getElementById(imgId).src = e.target.result;
                if(imgId === 'preview-panda') imgPandaBase64 = e.target.result;
                if(imgId === 'preview-cat') imgCatBase64 = e.target.result;
            };
            r.readAsDataURL(input.files[0]);
        }
    };

    window.saveAdmin = async () => {
        const data = {
            loginTitle: document.getElementById('admin-login-title').value,
            loginDesc: document.getElementById('admin-login-desc').value,
            tarotName: document.getElementById('admin-tarot-name').value,
            sajuName: document.getElementById('admin-saju-name').value,
            imgPanda: imgPandaBase64,
            imgCat: imgCatBase64
        };

        if(dbTarot) {
            await setDoc(doc(dbTarot, "settings", "global_config"), data, { merge: true });
            alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ë©ë‹ˆë‹¤.");
            location.reload();
        } else {
            alert("DB ì—°ê²° ì‹¤íŒ¨");
        }
    };

    async function loadConfig() {
        if(!dbTarot) return;
        try {
            const docSnap = await getDoc(doc(dbTarot, "settings", "global_config"));
            if(docSnap.exists()) {
                const d = docSnap.data();
                if(d.loginTitle) document.getElementById('login-title-text').innerText = d.loginTitle;
                if(d.loginDesc) document.getElementById('login-desc-text').innerText = d.loginDesc;
                if(d.tarotName) document.getElementById('text-panda').innerText = d.tarotName;
                if(d.sajuName) document.getElementById('text-cat').innerText = d.sajuName;
                
                if(d.imgPanda) {
                    document.getElementById('img-panda').src = d.imgPanda;
                    document.getElementById('mascot-tarot').src = d.imgPanda;
                }
                if(d.imgCat) {
                    document.getElementById('img-cat').src = d.imgCat;
                    document.getElementById('mascot-saju').src = d.imgCat;
                }
            }
        } catch(e) { console.log("Config load error", e); }
    }

    // --- Tarot Game Logic (ê¸°ì¡´ ìœ ì§€) ---
    const DECK_DATA = {
        waite: { name: "ìœ ë‹ˆë²„ì…œ ì›¨ì´íŠ¸", count: 78, pick: 3, cards: Array.from({length:78}, (_,i)=>`Waite Card ${i}`) },
        belline: { name: "í˜¸ë¡œìŠ¤ì½”í”„ ë²¨ë¦°", count: 53, pick: 3, cards: Array.from({length:53}, (_,i)=>`Belline Card ${i}`) },
        lenormand: { name: "ë ˆë…¸ë¨¼ë“œ", count: 36, pick: 3, cards: Array.from({length:36}, (_,i)=>`Lenormand Card ${i}`) }
    };
    const TAROT_SEQUENCE = ['waite', 'belline', 'lenormand'];

    window.startTarotFlow = () => {
        const q = document.getElementById('tarot-input').value;
        if(!q) return alert("ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”");
        gameState.question = q;
        gameState.finalSelections = {};
        runStage(0);
    };

    function runStage(idx) {
        if(idx >= TAROT_SEQUENCE.length) { showFinalResult(); return; }
        gameState.stageIdx = idx;
        const deckKey = TAROT_SEQUENCE[idx];
        const deckInfo = DECK_DATA[deckKey];

        document.getElementById('tarot-view-start').classList.add('hidden');
        document.getElementById('tarot-view-game').classList.add('hidden');
        document.getElementById('tarot-shuffle-view').classList.remove('hidden');

        // Fisher-Yates Shuffle
        const arr = [...deckInfo.cards];
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        gameState.currentDeck = arr;
        gameState.currentPicks = [];

        setTimeout(() => {
            document.getElementById('tarot-shuffle-view').classList.add('hidden');
            document.getElementById('tarot-view-game').classList.remove('hidden');
            renderTable(deckInfo);
        }, 1200);
    }

    function renderTable(info) {
        document.getElementById('tarot-deck-name').innerText = info.name;
        document.getElementById('tarot-deck-info').innerText = `${info.pick}ì¥ ì„ íƒ`;
        document.getElementById('tarot-selection-count').innerText = `0 / ${info.pick}`;
        document.getElementById('tarot-next-btn').classList.add('hidden');
        const table = document.getElementById('tarot-card-table');
        table.innerHTML = "";

        gameState.currentDeck.forEach((cardName, i) => {
            const card = document.createElement('div');
            card.className = "tarot-card-face";
            card.onclick = () => {
                const list = gameState.currentPicks;
                if(card.classList.contains('card-selected')) {
                    card.classList.remove('card-selected');
                    list.splice(list.indexOf(cardName), 1);
                } else {
                    if(list.length >= info.pick) return alert(`${info.pick}ì¥ë§Œ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
                    card.classList.add('card-selected');
                    list.push(cardName);
                }
                document.getElementById('tarot-selection-count').innerText = `${list.length} / ${info.pick}`;
                if(list.length === info.pick) document.getElementById('tarot-next-btn').classList.remove('hidden');
                else document.getElementById('tarot-next-btn').classList.add('hidden');
            };
            table.appendChild(card);
        });
    }

    window.confirmTarotSelection = () => {
        const key = TAROT_SEQUENCE[gameState.stageIdx];
        gameState.finalSelections[key] = gameState.currentPicks;
        runStage(gameState.stageIdx + 1);
    };

    async function showFinalResult() {
        document.getElementById('common-view-loading').classList.remove('hidden');
        const s = gameState.finalSelections;
        const prompt = `íƒ€ë¡œì ìˆ . ì§ˆë¬¸:"${gameState.question}". ì¹´ë“œ:[ì›¨ì´íŠ¸:${s.waite}],[ë²¨ë¦°:${s.belline}],[ë ˆë…¸ë¨¼ë“œ:${s.lenormand}]. íŒë‹¤ë§íˆ¬. Markdown.`;
        try {
            const text = await callGemini(prompt);
            displayResult(gameState.question, text);
            if(dbTarot) addDoc(collection(dbTarot, "tarot_readings"), { question: gameState.question, response: text, timestamp: new Date() });
        } catch(e) { alert(e.message); document.getElementById('common-view-loading').classList.add('hidden'); }
    }

    // --- Saju Logic ---
    window.processSajuManse = async () => {
        sajuState.info = { date: document.getElementById('saju-date').value, time: document.getElementById('saju-time').value, gender: document.getElementById('saju-gender').value };
        document.getElementById('common-view-loading').classList.remove('hidden');
        try {
            const res = await callGemini(`ë§Œì„¸ë ¥JSON. ì •ë³´:${JSON.stringify(sajuState.info)}. ì¶œë ¥JSON:{"pillars":["ê°‘ì","ì„ì¶•","ë³‘ì¸","ì •ë¬˜"],"colors":["wood","earth","fire","wood"]}`, true);
            const data = JSON.parse(res);
            sajuState.pillars = data.pillars;
            const el = document.getElementById('saju-pillars'); el.innerHTML="";
            data.pillars.forEach((p,i)=> el.innerHTML+=`<div class="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold ${data.colors[i]}">${p}</div>`);
            document.getElementById('common-view-loading').classList.add('hidden');
            document.getElementById('saju-view-icebreak').classList.remove('hidden');
        } catch(e) { document.getElementById('common-view-loading').classList.add('hidden'); }
    }

    window.startSajuConsult = async () => {
        const q = document.getElementById('saju-input').value;
        if(!q) return alert("ì…ë ¥í•˜ì„¸ìš”");
        document.getElementById('common-view-loading').classList.remove('hidden');
        try {
            const text = await callGemini(`ì‚¬ì£¼:${sajuState.pillars}. ì§ˆë¬¸:${q}. ê³ ì–‘ì´ë§íˆ¬. Markdown.`);
            displayResult(q, text);
            if(dbSaju) addDoc(collection(dbSaju, "saju_history"), { question: q, answer: text, date: new Date().toISOString() });
        } catch(e){}
    }

    function displayResult(q, text) {
        document.getElementById('common-view-loading').classList.add('hidden');
        document.getElementById('common-view-result').classList.remove('hidden');
        document.getElementById('result-question').innerText = q;
        document.getElementById('result-content').innerHTML = marked.parse(text);
    }

    async function callGemini(text, isJson=false) {
        if(!userApiKey) throw new Error("API Key ì—†ìŒ");
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${userApiKey}`;
        const body = { contents: [{ parts: [{ text }] }], generationConfig: isJson?{responseMimeType:"application/json"}:{} };
        const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
        const json = await res.json();
        return json.candidates[0].content.parts[0].text;
    }

    window.openHistory = async () => {
        const list = document.getElementById('history-list');
        document.getElementById('common-view-history').classList.remove('hidden');
        list.innerHTML = "ë¡œë”©...";
        const db = currentMode==='tarot'?dbTarot:dbSaju;
        const col = currentMode==='tarot'?'tarot_readings':'saju_history';
        const snap = await getDocs(query(collection(db, col), orderBy(currentMode==='tarot'?'timestamp':'date', 'desc'), limit(10)));
        list.innerHTML = "";
        snap.forEach(d => {
            const div = document.createElement('div');
            div.className = "bg-gray-100 p-3 rounded flex justify-between cursor-pointer hover:bg-gray-200";
            div.innerHTML = `<span class="truncate w-3/4">${d.data().question}</span><button onclick="deleteItem('${col}','${d.id}')">ğŸ—‘ï¸</button>`;
            div.onclick = (e) => { if(e.target.tagName!=='BUTTON') displayResult(d.data().question, d.data().response||d.data().answer); };
            list.appendChild(div);
        });
    }

    window.deleteItem = async (c, i) => {
        if(confirm("ì‚­ì œ?")) { await deleteDoc(doc(currentMode==='tarot'?dbTarot:dbSaju, c, i)); window.openHistory(); }
    }

    // CSS Injection
    const s = document.createElement('style');
    s.innerHTML = `.wood{background:#2e7d32}.fire{background:#d32f2f}.earth{background:#fbc02d;color:#3e2723}.metal{background:#757575}.water{background:#212121}`;
    document.head.appendChild(s);
</script>
</body>
</html>
